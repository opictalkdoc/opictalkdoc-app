# 소리담 → 오픽톡닥 이관 상세 분석 결과

> 소리담 소스코드: `C:\Users\js777\Desktop\soridam`
> 분석일: 2026-02-19
> 상태: **코드 레벨 상세 분석 완료 (핵심 코어 보강)**

---

## 목차

1. [프로젝트 구조](#1-소리담-프로젝트-구조)
2. [**핵심 코어: master_questions**](#2-핵심-코어-master_questions)
3. [**데이터 파이프라인: custom_mode_questions & DB 트리거**](#3-데이터-파이프라인-custom_mode_questions--db-트리거)
4. [모듈별 버전 분석 & 이관 매핑](#4-모듈별-버전-분석--최종-버전-매핑)
5. [모듈 의존성 & 이관 순서](#5-모듈-의존성--이관-순서)
6. [데이터랩 모듈 상세](#6-데이터랩-모듈-상세)
7. [모의고사 모듈 상세](#7-모의고사-모듈-상세)
8. [AI 튜터 모듈 상세](#8-ai-튜터-모듈-상세)
9. [스크립트 생성 모듈 상세](#9-스크립트-생성-모듈-상세)
10. [내 스크립트 모듈 상세](#10-내-스크립트-모듈-상세)
11. [쉐도잉 모듈 상세](#11-쉐도잉-모듈-상세)
12. [공통 인프라](#12-공통-인프라)
13. [DB 스키마 종합](#13-db-스키마-종합)
14. [Edge Functions 종합](#14-edge-functions-종합)
15. [오픽톡닥 이관 시 주의사항](#15-오픽톡닥-이관-시-주의사항)

---

## 1. 소리담 프로젝트 구조

```
soridam/
├── soridam-frontend/        # Next.js 14 App Router + React 18 + TypeScript
│   ├── app/
│   │   ├── training-lab/    # 학습 모듈
│   │   │   ├── mock-test/       # 모의고사 (V4/V6/V7 통합)
│   │   │   ├── my-mock-tests-v6/# 나의 모의고사 (V7 리포트)
│   │   │   ├── ai-tutor/        # AI 튜터 (V3)
│   │   │   ├── ai-training/     # 스크립트 생성 + 쉐도잉 진입
│   │   │   ├── my-scripts/      # 내 스크립트 (3패널)
│   │   │   └── shadowing/       # 쉐도잉 훈련
│   │   └── data-lab/        # 데이터 분석
│   │       ├── analysis/        # 출제 빈도 분석
│   │       └── submissions/     # 시험 후기 제출
│   ├── components/          # 공유 컴포넌트
│   ├── hooks/               # 커스텀 훅 (useMockTestV6 등)
│   ├── lib/
│   │   ├── api/             # API 레이어
│   │   ├── stores/          # Zustand 스토어
│   │   └── supabase/        # Supabase 클라이언트
│   └── types/               # TypeScript 타입 정의
├── supabase/
│   ├── migrations/          # DB 마이그레이션 (51개)
│   └── functions/           # Edge Functions (400+개)
│       └── _shared/         # 공통 유틸리티
├── cloudflare-workers/      # Cloudflare Workers
├── sql/                     # 추가 SQL 스크립트
└── scripts/                 # 유틸리티 스크립트
```

### 기술 스택

| 영역 | 소리담 | 오픽톡닥 |
|------|--------|---------|
| 프레임워크 | Next.js 14 (App Router) | Next.js (App Router) |
| 언어 | TypeScript | TypeScript (strict) |
| 스타일 | Tailwind CSS 3.x | Tailwind CSS 4.x |
| 상태관리 | Zustand | Zustand |
| 애니메이션 | Framer Motion | - |
| UI 아이콘 | Lucide Icons | Lucide Icons |
| 백엔드 | Supabase Edge Functions (Deno) | Supabase Edge Functions (Deno) |
| DB | Supabase PostgreSQL + RLS | Supabase PostgreSQL + RLS |
| 인증 | Supabase Auth | Supabase Auth |

---

## 2. 핵심 코어: master_questions

> **⚠️ master_questions는 소리담 전체 시스템의 중심 허브이다.**
> 69개 Edge Function이 이 테이블을 참조하며, 모든 학습 모듈이 이 테이블에서 시작된다.

### 왜 핵심 코어인가?

```
┌─────────────────────────────────────────────────────────────────┐
│                    master_questions (510개)                       │
│              시스템 전체의 단일 진실 소스 (SSOT)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ 데이터랩  │  │ 모의고사  │  │ AI 튜터  │  │ 스크립트  │       │
│  │          │  │          │  │          │  │ 생성     │       │
│  │ 후기제출  │  │ 문제출제  │  │ 진단/처방 │  │ 주제선택  │       │
│  │ 빈도분석  │  │ 평가분기  │  │ 훈련매칭  │  │ 질문기반  │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
│                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌───────────────────────┐        │
│  │내 스크립트│  │  쉐도잉   │  │  custom_mode_questions │        │
│  │          │  │          │  │  (DB 트리거 자동 생성)   │        │
│  │ 질문매칭  │  │ 질문표시  │  │  빈도기반 콤보 생성     │        │
│  └──────────┘  └──────────┘  └───────────────────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

### 프로덕션 스키마 (최종)

```sql
master_questions (
  id INTEGER (SERIAL) PRIMARY KEY,
  question_id VARCHAR(100) UNIQUE,      -- 'COM_APP_N_C1_01' (코드 시스템)
  survey_type VARCHAR(50),              -- '선택형' | '공통형' | '롤플레이'
  topic_category VARCHAR(100),          -- '일반' | '롤플레이' | '어드밴스'
  topic VARCHAR(255),                   -- '약속', '은행', '집', '호텔' 등
  question_english TEXT,                -- 영어 질문 원문
  question_korean TEXT,                 -- 한국어 번역
  answer_type VARCHAR(50),              -- 10가지 답변 유형 (시스템 분기 기준)
  audio_url TEXT,                       -- TTS 음성 URL (Gemini/OpenAI)
  audio_generated_at TIMESTAMPTZ,       -- 음성 생성 시각
  audio_voice VARCHAR(50),              -- 'Aoede' (Gemini) | 'nova' (OpenAI)
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
)
```

### question_id 코드 시스템

모든 질문은 **체계적인 코드 시스템**으로 식별된다:

```
{SEL/COM}_{topic_abbr}_{N/RP/A}_{C#}_{seq}

SEL = 선택형, COM = 공통형
topic_abbr = 주제 약어 (APP=약속, BNK=은행, HSE=집 등)
N = 일반, RP = 롤플레이, A = 어드밴스
C# = 콤보 세트 번호
seq = 세트 내 순번
```

**예시**:
| question_id | 해석 |
|-------------|------|
| `COM_APP_N_C1_01` | 공통형 / 약속 / 일반 / 세트1 / 1번 |
| `SEL_BNK_RP_C1_01` | 선택형 / 은행 / 롤플레이 / 세트1 / 1번 |
| `COM_TRV_A_C1_01` | 공통형 / 여행 / 어드밴스 / 세트1 / 1번 |

### 510개 질문 분포

#### survey_type별
| survey_type | 수량 | 비율 |
|-------------|------|------|
| 공통형 | 218개 | 42.7% |
| 롤플레이 | 192개 | 37.6% |
| 선택형 | 99개 | 19.4% |
| 시스템 | 1개 | 0.2% |

#### topic_category별
| topic_category | OPIc 문항 번호 | 특징 |
|----------------|---------------|------|
| 일반 | 2~10번 | description, routine, comparison, past_experience |
| 롤플레이 | 11~13번 | roleplay_11, roleplay_12, roleplay_13 |
| 어드밴스 | 14~15번 | advanced_14, advanced_15 |

### ⭐ answer_type (10가지) — 시스템 전체 분기 기준

> **answer_type은 단순 분류가 아니라, 평가 체크박스·스크립트 전략·훈련 모듈·AI 튜터 처방이 모두 이 값으로 분기된다.**

| # | answer_type | 한국어 | OPIc 문항 | 평가 체크박스 |
|---|-------------|--------|-----------|-------------|
| 1 | `description` | 묘사하기 | 2~10번 | INT 20개 |
| 2 | `routine` | 루틴 설명 | 2~10번 | INT 20개 |
| 3 | `comparison` | 비교하기 | 2~10번 | INT 20개 |
| 4 | `past_experience_memorable` | 과거경험(기억에 남는) | 2~10번 | INT 20개 |
| 5 | `past_experience_recent` | 과거경험(최근) | 2~10번 | INT 20개 |
| 6 | `past_experience_childhood` | 과거경험(어린시절) | 2~10번 | INT 20개 |
| 7 | `roleplay_11` | 롤플레이 11번 | 11번 | INT 20 + ADV 42 |
| 8 | `roleplay_12` | 롤플레이 12번 | 12번 | INT 20 + ADV 42 |
| 9 | `roleplay_13` | 롤플레이 13번 | 13번 | INT 20 + ADV 42 |
| 10 | `advanced_14` | 어드밴스 14번 | 14번 | INT 20 + ADV 42 |
|    | `advanced_15` | 어드밴스 15번 | 15번 | INT 20 + AL 12 |

> **주의**: past_experience는 원래 1개였으나 → memorable / recent / childhood 3개로 세분화됨.
> advanced도 원래 1개였으나 → advanced_14 / advanced_15로 세분화됨.
> Q15는 특별히 AL(Advanced Low) 진입 판별용 12개 체크박스가 별도 적용됨.

### answer_type → 시스템 분기 다이어그램

```
master_questions.answer_type
    │
    ├─→ 모의고사 평가 (mock-test-process-v7)
    │   ├─ description/routine/comparison/past_experience_* → INT 20개 체크박스
    │   ├─ roleplay_11/12/13, advanced_14 → INT 20 + ADV 42개 체크박스
    │   └─ advanced_15 (Q15) → INT 20 + AL 12개 체크박스
    │
    ├─→ AI 튜터 진단 (tutoring-start)
    │   └─ 10가지 유형별 약점 분석 → tutoring_progress 10개 생성
    │
    ├─→ AI 튜터 훈련 콘텐츠 (tutoring-generate-template-answer)
    │   └─ answer_type별 다른 스크립트 전략 (묘사 vs 루틴 vs 비교 vs ...)
    │
    ├─→ 스크립트 생성 (ai-training-generate-script-v6)
    │   └─ answer_type별 다른 GPT-4 프롬프트 + 구조화 전략
    │
    └─→ AI 튜터 find_similar_questions_by_frequency RPC
        └─ 같은 answer_type의 유사 질문 추천
```

### 음성 시스템

모든 510개 질문에 TTS 음성이 생성되어 있음:

| 필드 | 설명 |
|------|------|
| `audio_url` | Supabase Storage URL (`.wav` 또는 `.mp3`) |
| `audio_voice` | `Aoede` (Google Gemini TTS) 또는 `nova` (OpenAI TTS) |
| `audio_generated_at` | 생성 시각 |

음성은 모의고사 문제 읽기, 쉐도잉 훈련 등에서 사용.

### 스키마 진화 이력 (소리담 내부)

| Phase | 변경 내용 |
|-------|----------|
| Phase 1 | UUID PK, generic 구조 (opic/toeic_speaking 혼용) |
| Phase 2 | serial PK로 변경, OPIc 전용 컬럼 추가 (question_id, survey_type, topic_category, answer_type, audio_url) |
| Phase 3 | answer_type 세분화 (advanced → 14/15, past_experience → 3종) |
| Phase 4 | `find_similar_questions_by_frequency` RPC 추가 (AI 튜터용) |

> **오픽톡닥에서는 Phase 4 (최종 상태)만 이관한다.**

---

## 3. 데이터 파이프라인: custom_mode_questions & DB 트리거

> **custom_mode_questions는 사용자 시험 후기 데이터를 모의고사 출제에 연결하는 자동화된 데이터 파이프라인이다.**

### 핵심 데이터 흐름

```
사용자 시험 후기 제출 (DataLab Step 2)
    │
    ▼
submission_questions (14개 INSERT)
    │
    ▼ ── DB 트리거 자동 실행 ──
    │   process_custom_mode_questions()
    │
    ▼
custom_mode_questions (최대 5개 콤보 자동 생성)
    │
    ├─→ mock-test-create-v2 → generateQuestionsFromCombos()
    │   └─ 빈도 높은 콤보 우선 출제
    │
    ├─→ mock-test-combos-list
    │   └─ 커스텀 모드 UI에 콤보 목록 제공
    │
    └─→ mock-test-custom-preview
        └─ 콤보별 미리보기 (질문 목록)
```

### custom_mode_questions 스키마

```sql
custom_mode_questions (
  id SERIAL PRIMARY KEY,
  submission_id INTEGER NOT NULL,         -- submissions.id 참조
  combo_category VARCHAR(50),             -- '일반콤보1' | '일반콤보2' | '일반콤보3' | '롤플레이' | '어드밴스'
  topic VARCHAR(100),                     -- 주제 (예: '약속', '은행')
  question_ids VARCHAR(50)[] NOT NULL,    -- master_questions.question_id 배열
  frequency INTEGER DEFAULT 1,            -- 출제 빈도 (같은 콤보 반복 시 증가)
  created_at TIMESTAMP DEFAULT NOW()
)
```

### combo_category 체계

| combo_category | OPIc 문항 | 구성 | 설명 |
|----------------|-----------|------|------|
| `일반콤보1` | 2~4번 | question_ids[3] | 일반 질문 세트 1 |
| `일반콤보2` | 5~7번 | question_ids[3] | 일반 질문 세트 2 |
| `일반콤보3` | 8~10번 | question_ids[3] | 일반 질문 세트 3 |
| `롤플레이` | 11~13번 | question_ids[3] | 롤플레이 질문 세트 |
| `어드밴스` | 14~15번 | question_ids[2] | 어드밴스 질문 세트 |

> **1개 시험 후기 = 최대 5개 콤보 레코드** (일반3 + 롤플레이1 + 어드밴스1)

### DB 트리거: process_custom_mode_questions()

```sql
-- submission_questions INSERT 시 자동 실행
CREATE TRIGGER trigger_process_custom_mode_questions
  AFTER INSERT ON submission_questions
  FOR EACH ROW
  EXECUTE FUNCTION process_custom_mode_questions();
```

**트리거 실행 로직**:

```
1. 대기: 해당 submission_id의 submission_questions가 14개 모일 때까지 대기
   (14개 미만이면 아무 동작 안 함)

2. 중복 확인: custom_mode_questions에 이미 해당 submission_id가 있으면 SKIP

3. 필터링:
   - master_question_id IS NOT NULL인 것만 (기억 못하는 질문 제외)
   - 특정 주제 제외: 카페/하이킹/공원 (일반+어드밴스 카테고리에서)

4. 그룹핑: combo_type + topic 기준으로 GROUP BY
   - 일반 질문 → 3문항씩 콤보 (일반콤보1, 일반콤보2, 일반콤보3)
   - 롤플레이 → 3문항 콤보 (롤플레이)
   - 어드밴스 → 2문항 콤보 (어드밴스)

5. 완전성 검증:
   - 일반콤보: 정확히 3개 question_ids 필요
   - 롤플레이: 정확히 3개 question_ids 필요
   - 어드밴스: 정확히 2개 question_ids 필요
   - 불완전한 콤보는 생성하지 않음

6. INSERT: 검증 통과한 콤보만 custom_mode_questions에 저장
   - 최대 5개 레코드 / 후기 1건
```

### 모의고사 출제에서의 활용

```typescript
// mock-test-create-v2/generateQuestions.ts

// 모드별 질문 생성 로직:
// 1. frequent 모드: frequency 높은 콤보 우선 → master_questions에서 질문 조회
// 2. custom 모드: 사용자 선택 콤보 → master_questions에서 질문 조회
// 3. recent 모드: 최신 submissions 기반

async function generateQuestionsFromCombos(combos: CustomModeQuestion[]) {
  // 1. 콤보별 question_ids 추출
  // 2. master_questions에서 question_english, audio_url, answer_type 조회
  // 3. 15문제 구성: 자기소개(1) + 일반(9) + 롤플레이(3) + 어드밴스(2)
  // 4. answer_type에 따라 평가 체크박스 세트 결정
}
```

### 프로덕션 데이터 현황

- 총 **98개** 레코드 (2026-02-19 기준)
- 가장 빈도 높은 콤보: frequency 5~8 (반복 출제 콤보)
- 콤보당 평균 question_ids: 2.7개

### find_similar_questions_by_frequency RPC

AI 튜터에서 사용하는 유사 질문 추천 함수:

```sql
-- 같은 answer_type + 높은 frequency의 질문 추천
CREATE FUNCTION find_similar_questions_by_frequency(
  p_answer_type VARCHAR,
  p_topic VARCHAR,
  p_limit INT DEFAULT 5
) RETURNS SETOF master_questions AS $$
  SELECT mq.*
  FROM master_questions mq
  JOIN custom_mode_questions cmq ON mq.question_id = ANY(cmq.question_ids)
  WHERE mq.answer_type = p_answer_type
    AND mq.topic != p_topic  -- 같은 주제 제외
  ORDER BY cmq.frequency DESC
  LIMIT p_limit;
$$;
```

---

## 4. 모듈별 버전 분석 & 최종 버전 매핑

### 이관 대상 모듈

| # | 모듈 | 소리담 경로 | 소리담 최종 버전 | 오픽톡닥 |
|---|------|-----------|----------------|---------|
| 1 | **데이터랩** | `data-lab/` | 단일 버전 | `data-lab` (v1) |
| 2 | **스크립트 생성** | `training-lab/ai-training/` | v6 (generate-script-v6) | `script-gen` (v1) |
| 3 | **모의고사** | `training-lab/mock-test/` | v7 평가 시스템 | `mock-test` (v1) |
| 4 | **나의 모의고사** | `training-lab/my-mock-tests-v6/` | v6 (목록/세션 상세) | `my-mock-tests` (v1) |
| 5 | **모의고사 리포트** | `training-lab/my-mock-tests-v6/[sessionId]` | v7 리포트 | `mock-test/report` (v1) |
| 6 | **AI 튜터** | `training-lab/ai-tutor/` | v3 (진단→처방→훈련) | `ai-tutor` (v1) |
| 7 | **내 스크립트** | `training-lab/my-scripts/` | 단일 버전 (3패널) | `my-scripts` (v1) |
| 8 | **쉐도잉 훈련** | `training-lab/shadowing/` | 단일 버전 (4모드) | `shadowing` (v1) |

### 버전 존재하지만 미사용 (레거시)

| 모듈 | 소리담 경로 | 사유 |
|------|-----------|------|
| 모의고사 v6 | `training-lab/mock-test-v6/` | → v7로 대체 |
| 나의 모의고사 (구) | `training-lab/my-mock-tests/` | → v6로 대체 |
| AI 훈련 레거시 | `training-lab/ai-training-legacy/` | → AI 튜터로 대체 |
| AI 훈련 | `training-lab/ai-training/` | 스크립트 생성만 이관, 나머지 대체됨 |

### 미이관 (오픽톡닥에 불필요)

| 모듈 | 소리담 경로 | 사유 |
|------|-----------|------|
| 톡리시 | `training-lab/talklish/` | 미포함 |
| 강의 | `training-lab/lectures/` | 미포함 |
| 펀 잉글리시 | `training-lab/fun-english/` | 미포함 |
| 시험 게시판 | `test-board/` | 미포함 |
| 게시판 | `board/` | 미포함 |
| 튜토리얼 | `tutorials/` | 미포함 |
| 인트로 | `intro/`, `intro-v2/` | 미포함 |
| 가이드 | `guide/`, `guide-legacy/` | 미포함 |
| Eva-Tutor | `ai-tutor/eva-tutor/` | 실시간 WebRTC, 향후 검토 |

---

## 5. 모듈 의존성 & 이관 순서

### 의존성 다이어그램 (master_questions 중심)

```
                    ┌─────────────────┐
                    │ master_questions │ ← 510개 OPIc 질문 (시스템 코어)
                    │   (SSOT)        │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
     ┌──────────────┐ ┌──────────┐ ┌──────────────┐
     │  데이터랩     │ │스크립트   │ │  모의고사     │
     │              │ │생성      │ │              │
     │ submissions  │ │ GPT-4    │ │ 세션+15문제   │
     │ sub_questions│ │ 스크립트  │ │ V7 평가      │
     └──────┬───────┘ └────┬─────┘ └──────┬───────┘
            │              │              │
            ▼              ▼              ▼
  ┌──────────────────┐ ┌────────┐ ┌──────────────┐
  │custom_mode_      │ │내      │ │  AI 튜터     │
  │questions         │ │스크립트 │ │              │
  │(DB 트리거 자동)   │ │        │ │ 진단→처방    │
  └────────┬─────────┘ └────┬───┘ │ →훈련        │
           │                │     └──────────────┘
           │                ▼
           │          ┌──────────┐
           └─────────→│  쉐도잉  │
    (빈도 기반 출제)    │ 4모드    │
                      └──────────┘
```

### 이관 순서 (확정)

1. **데이터랩** — 기반 데이터 (master_questions, submissions, custom_mode_questions + DB 트리거)
2. **스크립트 생성** — 빈도 데이터 활용, 스크립트/패키지 생성
3. **모의고사** — 세션 생성 → 15문제 (콤보 기반) → V7 평가 → 리포트
4. **AI 튜터** — 모의고사 결과 기반 진단 → 처방 → 훈련
5. **내 스크립트** — 생성된 스크립트 목록/학습/오디오 재생
6. **쉐도잉** — 패키지 기반 4모드 훈련

---

## 6. 데이터랩 모듈 상세

### 개요

실제 OPIc 시험 후기를 기반으로 한 **출제 경향 분석 및 시험 정보 공유 플랫폼**. 3단계 마법사 형식의 후기 제출 + 실시간 데이터 분석이 핵심.

> **데이터랩은 master_questions에 실제 출제 데이터를 공급하는 유일한 채널이며, 후기 제출 시 DB 트리거를 통해 custom_mode_questions를 자동 생성한다.**

### 페이지 구조

```
data-lab/
├── page.tsx                    # 메인 대시보드 (총 후기, 통계 카드)
├── analysis/page.tsx           # 출제 빈도 분석 (카테고리별 탭)
└── submissions/
    ├── new/page.tsx            # 후기 제출 마법사 (Step 1→2→3)
    ├── my-list/page.tsx        # 내 제출 목록
    ├── [id]/page.tsx           # 후기 상세보기
    └── [id]/complete/page.tsx  # 제출 완료 페이지
```

### 핵심 데이터 플로우

#### 메인 대시보드

```
페이지 로드 → data-lab-stats API 호출
→ 응답: { total_submissions, total_unique_questions,
          by_difficulty: {"6-6": 45, ...},
          by_achieved_level: {"AL": 15, "IH": 28, ...} }
→ 4개 통계 카드 애니메이션 렌더링
→ 난이도/등급 플립 애니메이션 (2초 간격)
```

#### 출제 빈도 분석 페이지

```
분석 페이지 진입
→ analysis-frequency API 호출 (연도 필터 가능)
→ 카테고리별 탭 (일반/롤플레이/어드밴스)
→ 유형별 (선택형/자유형/사용자제안)
→ 주제별 출제 빈도 테이블 (순위, 주제, 빈도, 비율)
→ 주제 클릭 → analysis-topic-questions API → 실제 출제 문제 모달
```

**접근 제어**:
- 미로그인: 어드밴스 카테고리만 공개
- 로그인: 모든 카테고리 공개

#### 후기 제출 (3단계 마법사) — custom_mode_questions 자동 생성 트리거

**Step 1: 기본 정보 & 서베이**
- 시험 날짜, 난이도 (6-6, 6-5, 5-5 등), 응시 전/후 등급
- 배경설문 14개 항목 (직업, 학생 여부, 여가활동, 취미, 운동, 여행 등)
- 서베이 최소 12개 선택 필요
- API: `submissions-step1` → 드래프트 저장 (status='draft')

**Step 2: 질문 입력 (14개 문제) ⭐ DB 트리거 발동 지점**
- 2번~15번 질문 입력 (1번은 자기소개)
- QuestionSelector: 콤보 타입, 주제, 마스터 질문 ID 매칭
- master_questions DB에서 기존 질문 제안
- API: `submissions-step2` → **submission_questions 14개 INSERT**
- **→ DB 트리거 `process_custom_mode_questions()` 자동 실행**
- **→ custom_mode_questions 최대 5개 콤보 자동 생성**

**Step 3: 후기 & 팁**
- 전체 후기 텍스트 + 꿀팁 (선택)
- API: `submissions-step3` → 100포인트 지급, status='complete'

#### 성적 입력 시스템

```typescript
// 시험일 + 7일 오후 1시 이후 = 결과 발표
const isResultReleased = (examDate: string): boolean => {
  const resultDate = new Date(examDate);
  resultDate.setDate(resultDate.getDate() + 7);
  resultDate.setHours(13, 0, 0, 0);
  return new Date() >= resultDate;
};
```

### 핵심 API

| API | 메서드 | 인증 | 설명 |
|-----|--------|------|------|
| `data-lab-stats` | GET | Optional | 전체 통계 |
| `analysis-frequency` | GET | Optional | 주제별 빈도 분석 (연도 필터) |
| `analysis-topic-questions` | GET | Optional | 주제별 실제 출제 문제 |
| `submissions-step1` | POST | Required | Step 1 저장 |
| `submissions-step2` | POST | Required | Step 2 저장 → **DB 트리거 발동** |
| `submissions-step3` | POST | Required | Step 3 완료 |
| `submissions-my` | GET | Required | 내 후기 목록 (페이지네이션) |
| `submissions-detail` | GET | Optional | 후기 상세 |

### 핵심 타입

```typescript
interface DataLabStats {
  total_submissions: number;
  total_unique_questions: number;
  additional_stats: {
    by_difficulty: Record<string, number>;
    by_achieved_level: Record<string, number>;
  };
}

interface FrequencyAnalysisResponse {
  categories: Array<{
    category: "일반" | "롤플레이" | "어드밴스";
    s_types: Array<{
      s_type: "선택형" | "자유형" | "사용자 제안";
      topics: Array<{ topic: string; frequency: number; percentage: number }>;
    }>;
    max_frequency: number;
  }>;
  stats: {
    total_submissions: number;
    available_years: number[];
    is_authenticated: boolean;
  };
}
```

### DB 테이블

```sql
-- submissions (후기 제출)
submissions (
  id SERIAL PRIMARY KEY,
  user_id UUID,
  exam_date DATE,
  grade_before_exam VARCHAR(10),
  achieved_level VARCHAR(10),
  exam_difficulty VARCHAR(10),       -- "6-6", "6-5", "5-5"
  status VARCHAR(20),                -- 'draft' | 'complete'
  step_completed INT,
  overall_review TEXT,
  tips TEXT,
  used_recommended_survey BOOLEAN,
  survey_data JSONB,                 -- 배경설문
  created_at TIMESTAMPTZ
)

-- submission_questions (질문 기록) → 14개 INSERT 시 DB 트리거 발동
submission_questions (
  id SERIAL PRIMARY KEY,
  submission_id INT REFERENCES submissions(id),
  question_number INT,               -- 2~15
  combo_type VARCHAR(50),            -- '일반콤보1', '일반콤보2', '일반콤보3', '롤플레이', '어드밴스'
  topic VARCHAR(100),
  master_question_id VARCHAR(100),   -- master_questions.question_id 참조
  is_not_remembered BOOLEAN
)
```

### 다른 모듈과의 연결

- **custom_mode_questions**: Step 2 완료 시 DB 트리거로 **자동 생성** → 모의고사 출제 데이터
- **스크립트 생성**: `analysisApi.getFrequencyAnalysis()` → 자주 출제되는 주제 우선 표시
- **모의고사**: custom_mode_questions의 콤보 + frequency → 빈도 높은 문제 조합 출제
- **AI 튜터**: `find_similar_questions_by_frequency` RPC → 약점 부분 유사 질문 추천

---

## 7. 모의고사 모듈 상세

### 개요

3단계 평가 시스템 (V4/V6/V7)으로 구성. **V7이 최신이며 이관 대상**. 62개 체크박스 + TypeScript 규칙 엔진으로 ACTFL 등급 판정.

> **모의고사의 15문제는 master_questions에서 조회되며, 각 문제의 answer_type에 따라 평가 체크박스 세트가 결정된다.**

### 버전별 비교

| 항목 | V4 (기본) | V6 (베타) | V7 (최신 → 이관) |
|------|-----------|-----------|-----------------|
| 평가 방식 | 단순 점수 | 34개 체크박스 + LLM | 62개 체크박스 + TS 규칙엔진 |
| 체크박스 | 없음 | 34개 (F1~F5) | 62개 (INT 20 + ADV 42 + AL 12) |
| 레벨 판정 | LLM 직접 | LLM 직접 | **규칙엔진 (TypeScript)** |
| 발음 평가 | 없음 | Azure (선택) | Azure (선택) |
| 이중 상태 | 없음 | 없음 | **rule_engine + report** |
| 대상 | 일반 | 베타 테스터 | 베타/관리자 |

### 전체 플로우

```
1. 세션 생성 (mock-test-create-v2)
   → custom_mode_questions에서 콤보 선택 (frequent/custom/recent 모드)
   → master_questions에서 question_english, audio_url, answer_type 조회
   → { session_id, questions[15], usage_method, api_provider }

2. 15개 문제 순서대로 풀기
   → 각 문제마다 음성 녹음 + 제출 (mock-test-submit-v2)
   → 백그라운드: STT + Azure 발음 평가 (병렬)

3. V7 평가 처리 (mock-test-process-v7)
   → 15개 답변 각각 answer_type 기반 체크박스 개별평가
   → Q15 완료 시 규칙엔진 자동 실행
   → 리포트 생성 트리거 (fire-and-forget)

4. 상태 폴링 (mock-test-status-v7, 2초 간격)
   → V7StatusResponse { rule_engine_status, report_status }

5. 리포트 표시
   → 최종 레벨, FACT 점수, 진단 폼, 우선순위 훈련 항목
```

### V7 체크박스 구조 (answer_type 기반 분기)

```
INT (중급 기능): 20개
  - 시제 활용, 문단 구성, 주제 다양성 등
  - 모든 answer_type에 공통 적용

ADV (고급 기능): 42개
  - 복잡한 문법, 논리적 전개, 고급 어휘 등
  - roleplay_11/12/13, advanced_14에 적용

AL (Advanced Low 판별): 12개
  - Q15 (advanced_15) 전용
  - 고급 진입 판별 (INT 20 + AL 12)
```

### V7 규칙엔진 로직

```
1. Q1~Q14: 개별평가 (answer_type 따라 INT 20개 또는 INT 20 + ADV 42개)
2. Q15: 심화평가 (INT 20개 + AL 12개)
3. 체크박스 집계 (14/15문항 중 pass 비율)
4. Floor Status 판정 (N/I/IM1/IM2/IM3 최저)
5. Ceiling Status 판정 (Random/Emerging/Developing/Meets)
6. Q15 AL 체크박스 기반 AL 판정
7. Gate-Keeper (F4 돌발) → 레벨 캡핑
8. 최종 레벨 결정
9. 리포트 생성 트리거
```

### FACT 점수 시스템

```
F (Functions): 15개 체크박스 → 0-10점
A (Accuracy): 31개 체크박스 → 0-10점
C (Context): 5개 체크박스 → 0-10점
T (Text Type): 11개 체크박스 → 0-10점
총점: 0-40점

점수 = (통과 체크박스 / 평가 체크박스) × 10
```

### 상태관리 (useMockTestV6 훅)

```typescript
// useReducer 기반
type MockTestState = {
  phase: 'start' | 'survey' | 'welcome' | 'session' | 'evaluating' | 'result' | 'report'
  sessionId: string
  questions: Question[]
  currentQuestionIndex: number
  submittedAnswers: number[]
  isLoading: boolean
  error: MockTestError | null
  activeSession: MockTestSession | null
}

// 주요 액션: SET_PHASE, SET_SESSION, NEXT_QUESTION, ADD_SUBMITTED_ANSWER
// 주요 메서드: createSession(), resumeSession(), submitAnswer(), getStatus()
```

### 오디오 검증 규칙

- 최소 1초 (MIN_AUDIO_DURATION)
- 최대 4분 (MAX_AUDIO_DURATION)
- 최대 10MB (MAX_AUDIO_SIZE)
- WAV 형식 권장

### 에러 처리

```typescript
class MockTestError extends Error {
  code: 'INSUFFICIENT_CREDITS' | 'INSUFFICIENT_POINTS' | 'TIMEOUT' | 'API_ERROR'
  required?: number   // 필요 포인트
  current?: number    // 현재 포인트
  suggestions?: string[] // 해결 방법
}
```

### 핵심 API

| API | 용도 |
|-----|------|
| `mock-test-create-v2` | 세션 생성 (콤보 기반 15문제) |
| `mock-test-submit-v2` | 답변 제출 (오디오) |
| `mock-test-process-v7` | V7 평가 + 규칙엔진 (Q15 시 자동) |
| `mock-test-status-v7` | 상태 폴링 (rule_engine + report) |
| `mock-test-history-v7` | V7 히스토리 + 성장 추이 |
| `mock-test-active-session` | 활성 세션 확인 (이어하기) |
| `mock-test-combos-list` | 커스텀 모드 콤보 목록 |
| `mock-test-custom-preview` | 콤보별 질문 미리보기 |

### DB 테이블

```sql
-- mock_test_sessions (세션)
mock_test_sessions (
  id UUID PRIMARY KEY,
  user_id UUID,
  mode VARCHAR(20),           -- 'frequent' | 'recent' | 'custom'
  status VARCHAR(20),         -- 'active' | 'completed' | 'expired'
  questions JSONB,            -- Question[15] (master_questions에서 조회)
  created_at TIMESTAMPTZ
)

-- mock_test_evaluations_v7 (개별 평가)
mock_test_evaluations_v7 (
  id UUID PRIMARY KEY,
  session_id UUID,
  question_number INT,        -- 1~15
  answer_type VARCHAR(100),   -- master_questions.answer_type (10가지)
  checkbox_type VARCHAR(10),  -- 'INT', 'ADV', 'AL'
  checkboxes JSONB,           -- { 'INT-1-1': { pass: true, evidence: '...' } }
  pass_count INT,
  fail_count INT,
  pass_rate DECIMAL,
  corrected_answer TEXT,
  speech_analysis JSONB,      -- { wpm, filler_count }
  pronunciation_assessment JSONB  -- Azure 결과
)

-- mock_test_holistic_evaluations_v7 (종합 평가)
mock_test_holistic_evaluations_v7 (
  id UUID PRIMARY KEY,
  session_id UUID,
  rule_engine_status VARCHAR(20),  -- 'pending' | 'completed' | 'failed'
  report_status VARCHAR(20),       -- 'pending' | 'processing' | 'completed' | 'failed'
  final_level VARCHAR(10),         -- 'NL' | 'NH' | 'IL' | ... | 'AL'
  fact_scores JSONB,               -- { F, A, C, T, total }
  diagnostic_form JSONB,           -- F1~F5 성과 수준
  priority_training JSONB,         -- 우선순위 훈련 항목[3]
  report_feedback TEXT,            -- 종합 피드백 (한글)
  pronunciation_stats JSONB        -- 발음 통계
)
```

---

## 8. AI 튜터 모듈 상세

### 개요

모의고사 평가 결과를 기반으로 **진단 → 처방 → 훈련** 파이프라인 제공. V3가 최신. 8대 스킬 + 40개 원인코드 체계, Phase 1~3 훈련 구조, Sori & Dam 듀얼 튜터 캐릭터.

> **AI 튜터는 mock_test_evaluations_v7의 answer_type별 체크박스 결과를 기반으로 10가지 유형별 약점을 진단하고, find_similar_questions_by_frequency RPC로 유사 질문을 추천한다.**

### 전체 플로우

```
모의고사 완료 (mock_test_evaluations_v7)
    ↓
AI 튜터 시작 (tutoring-start)
    → 10가지 answer_type별 약점 분석
    → tutoring_sessions 생성
    → tutoring_progress 10개 생성 (유형별)
    ↓
진단 결과 (diagnosis)
    → FACT 레이더 차트
    → Worst 5 유형 표시
    → 맞춤 처방 카드
    ↓
훈련 (training)
    ├─ Level 1: 드래그 앤 드롭 (parts[] 빈칸 채우기)
    ├─ Level 2: 키워드 힌트 + 말하기 (≥80점 1회)
    ├─ Level 3: 슬롯 함수만 + 말하기 (≥80점 1회)
    └─ Real Test: 질문만 + 말하기 (≥80점 3회)
    ↓
유형 완료 → 다음 유형 → 전체 완료
```

### 페이지 구조

```
ai-tutor/
├── page.tsx                              # 대시보드 (모의고사 선택)
├── [sessionId]/
│   ├── diagnosis/page.tsx                # 진단 결과
│   └── training/[progressId]/
│       ├── page.tsx                      # 훈련 메인 (레벨 선택)
│       ├── level/[level]/page.tsx        # Level 1/2/3 훈련
│       └── test/page.tsx                 # Real Test
```

### 8대 스킬 체계

| 코드 | 스킬 | 한국어 | 담당 튜터 |
|------|------|--------|-----------|
| TF | Time Frame | 시간 프레임 | 담 |
| LC | Logic Connection | 논리 연결 | 담 |
| AC | Accuracy | 정확성 | 담 |
| VC | Vocabulary Context | 어휘 맥락 | 담 |
| FL | Fluency | 유창성 | **소리** |
| QM | Question Management | 질문 관리 | 담 |
| UN | Unexpected Handling | 돌발 대처 | 담 |
| PR | Pronunciation | 발음/억양 | **소리** |

### Phase별 구조

**Phase 1: 스킬 훈련 (Diagnostic Skill Drills)**
- 8대 스킬별 4단계: 약점 설명 → 틀린 부분 → 교정+예시 → 이해 확인
- 담당 튜터: FL/PR → '소리', 나머지 → '담'

**Phase 2: 모듈 훈련 (Module-Based)**
- 48개 훈련 모듈 → 3가지 트랙
  - QUIT_CONTROL (문장 완성도)
  - RP11_CORE (롤플레이 기본)
  - ADV_NARRATIVE (고급 서사)
- 각 모듈: READ (2분) → TYPE (6분) → SPEAK (2분)

**Phase 3: 통합 테스트 (Real-World Simulation)**
- 모의고사 형식의 실전 테스트
- RecordRTC → WAV → Whisper STT → AI 평가
- 통과 조건: ≥80점, 3회 필요 (유형별)

### 템플릿 답변 구조 (핵심)

```typescript
interface TemplateSlot {
  slot_index: number;
  slot_function: string;          // "주제 제시", "상세 묘사"
  used_template: string;          // "Let me describe ___"
  text: string;
  parts: Array<{
    type: 'template' | 'expression';
    text: string;
    slot_id?: string;             // expression: 'SLOT_0_EXP_1'
  }>;
  keywords: string[];
  checkboxes: string[];           // ['INT-1-1', 'INT-3-1']
  paragraph: 'intro' | 'body1' | 'body2' | 'body3' | 'conclusion';
  translation_ko: string;
}
```

### 레벨별 훈련 콘텐츠

```typescript
// Level 1: 드래그 앤 드롭
interface TrainingContentLevel1 {
  type: 'drag_and_drop';
  slots: Array<{ slot_index, slot_function, parts[], translation_ko }>;
  expression_pool: Array<{ slot_id, text }>;
  drag_options: Array<{ id, text, slot_index }>;
}

// Level 2: 키워드 힌트
interface TrainingContentLevel2 {
  type: 'keyword_hint';
  slots: Array<{ slot_index, slot_function, keywords[], template_structure }>;
}

// Level 3: 슬롯 함수만
interface TrainingContentLevel3 {
  type: 'slot_function_only';
  slots: Array<{ slot_index, slot_function, paragraph, paragraph_label }>;
}
```

### 핵심 API

| API | 메서드 | 설명 |
|-----|--------|------|
| `tutoring-start` | POST | 세션 생성 (모의고사 기반, 10가지 answer_type별) |
| `tutoring-get-diagnosis` | GET | 진단 결과 + FACT + 예측 등급 |
| `tutoring-get-progress` | GET | 유형별 진행 상태 + 훈련 콘텐츠 |
| `tutoring-get-original-answer` | GET | 모의고사 원본 답변 |
| `tutoring-generate-template-answer` | POST | AI 교정 답변 생성 (GPT-4, answer_type별 전략) |
| `tutoring-evaluate-attempt` | POST | 레벨별 시도 평가 |
| `tutoring-next-question` | POST | 다음 유형으로 이동 |

### DB 테이블

```sql
-- tutoring_sessions (훈련 세션)
tutoring_sessions (
  id UUID PRIMARY KEY,
  user_id UUID,
  mock_test_session_id UUID,
  target_level VARCHAR(10),
  status VARCHAR(20),                -- 'active' | 'paused' | 'completed'
  total_types INT DEFAULT 10,        -- 10가지 answer_type
  completed_types INT DEFAULT 0,
  current_type_index INT DEFAULT 0
)

-- tutoring_progress (유형별 진행)
tutoring_progress (
  id UUID PRIMARY KEY,
  session_id UUID,
  user_id UUID,
  evaluation_id UUID,               -- mock_test_evaluations_v7 참조
  template_answer_id UUID,
  answer_type VARCHAR(100),          -- master_questions.answer_type (10가지)
  target_level VARCHAR(10),
  status VARCHAR(20),                -- 'pending' | 'in_progress' | 'completed'
  current_level VARCHAR(20),         -- 'level1' | 'level2' | 'level3' | 'real_test'
  level2_passed INT DEFAULT 0,
  level3_passed INT DEFAULT 0,
  realtest_passed INT DEFAULT 0,     -- 3회 필요
  before_checkboxes TEXT[],
  after_checkboxes TEXT[],
  type_index INT                     -- 0-9
)

-- tutoring_template_answers (AI 교정 답변)
tutoring_template_answers (
  id UUID PRIMARY KEY,
  progress_id UUID,
  question_id INT,                   -- master_questions.id 참조
  answer_type VARCHAR(100),
  target_level VARCHAR(10),
  total_slots INT,
  slots JSONB,                       -- TemplateSlot[]
  full_script TEXT,
  full_script_ko TEXT,
  word_count INT,
  user_original_answer TEXT
)

-- tutoring_training_attempts (훈련 시도)
tutoring_training_attempts (
  id UUID PRIMARY KEY,
  progress_id UUID,
  attempt_number INT,
  training_level VARCHAR(20),        -- 'level1' ~ 'real_test'
  user_answer TEXT,
  user_audio_url TEXT,
  score INT,
  passed BOOLEAN,
  slot_evaluations JSONB,
  checkbox_evaluation JSONB,
  overall_feedback TEXT
)

-- tutoring_prompts (AI 프롬프트)
tutoring_prompts (
  id UUID PRIMARY KEY,
  prompt_key VARCHAR(50) UNIQUE,     -- 'generate_template', 'evaluate_level', 'evaluate_realtest'
  prompt_text TEXT,
  model VARCHAR(50) DEFAULT 'gpt-4.1',
  temperature DECIMAL(2,1) DEFAULT 0.7,
  max_tokens INT DEFAULT 4000,
  response_format VARCHAR(20) DEFAULT 'json'
)

-- ai_tutor_skills (8대 스킬 + 40개 원인코드)
ai_tutor_skills (
  id UUID PRIMARY KEY,
  skill_code VARCHAR(10),            -- 'TF', 'LC', ...
  cause_code VARCHAR(10),            -- 'TF01', 'TF02', ...
  level INT,                         -- 1: 스킬, 2: 원인코드
  name_ko VARCHAR(100),
  name_en VARCHAR(100),
  gate_criteria JSONB,
  scoring_rubric JSONB,
  primary_modules VARCHAR(10)[],
  weight DECIMAL(3,2) DEFAULT 1.00
)

-- ai_tutor_characters (Sori & Dam 튜터)
ai_tutor_characters (
  id UUID PRIMARY KEY,
  character_id VARCHAR(20) UNIQUE,   -- 'sori', 'dam'
  display_name VARCHAR(50),
  role VARCHAR(50),
  primary_phase VARCHAR(50),
  primary_skills JSONB,
  system_prompt TEXT
)

-- ai_tutor_training_modules (48개 훈련 모듈)
ai_tutor_training_modules (
  id UUID PRIMARY KEY,
  module_code VARCHAR(10) UNIQUE,    -- 'M01-01'
  module_name VARCHAR(100),
  target_skill_code VARCHAR(10),
  target_cause_codes VARCHAR(10)[],
  phase_read JSONB,
  phase_type JSONB,
  phase_speak JSONB,
  character_id VARCHAR(20),
  estimated_minutes INT
)
```

---

## 9. 스크립트 생성 모듈 상세

### 개요

AI 훈련소 페이지에서 주제/질문 선택 → GPT-4로 스크립트 자동 생성 → 수동 편집 → 패키지 생성 (TTS + PDF + timestamp + JSON).

> **스크립트 생성은 master_questions에서 질문을 가져오고, answer_type에 따라 다른 GPT-4 프롬프트 전략을 사용한다.**

### 생성 플로우

```
1. 카테고리 선택 (일반/롤플레이/어드밴스)
   → aiTrainingApi.getQuestionsWithScripts()
   → analysisApi.getFrequencyAnalysis() (빈도 데이터 활용)

2. 주제/질문 선택
   → master_questions에서 질문 조회 (question_english, answer_type)
   → 빈도순 정렬, 진행 상태 표시

3. "스크립트 생성" 클릭
   → /ai-training/create?questionId=X&category=Y

4. Step 1: 주제 + 스토리 입력 (선택사항)

5. Step 2: AI 스크립트 생성
   → Edge Function: ai-training-generate-script-v6
   → AIPermissionService 권한 체크
   → GPT-4 호출 (answer_type별 다른 프롬프트, 캐시 확인)
   → { script_id, english_text, korean_translation, key_vocabulary[] }

6. Step 3: 스크립트 편집 (수동 수정, AI 정제 옵션)
   → ai-training-refine-script (선택)

7. Step 4: 패키지 생성
   → ai-training-generate-package
   → TTS 생성 (음성)
   → PDF 생성
   → timestamp_data 생성 (문장별 시작/종료 시간)
   → JSON 생성 (쉐도잉 메타데이터)
   → status: processing → completed
```

### 권한 체크 시스템

```typescript
// AIFeature.AI_TRAINING_GENERATE_SCRIPT
// 4가지 방식 중 하나 필요:
// 1. 구독 (subscription)
// 2. API 키 (api_key) - 개인 OpenAI 키
// 3. 포인트 (points)
// 4. 관리자 (admin)
```

### 핵심 API

| API | 용도 | 입력 | 출력 |
|-----|------|------|------|
| `ai-training-generate-script-v6` | 스크립트 생성 | question_id, category, level, story | script_id, english_text |
| `ai-training-refine-script` | 스크립트 수정 | script_id, edited_content | 수정된 텍스트 |
| `ai-training-generate-package` | 패키지 생성 | script_id | package_id, status |
| `ai-training-package-status` | 패키지 상태 | package_id | status, progress |

### DB 테이블

```sql
-- ai_training_scripts (스크립트)
ai_training_scripts (
  id UUID PRIMARY KEY,
  user_id UUID,
  question_id INT,               -- master_questions.id 참조
  english_text TEXT,
  korean_translation TEXT,
  sentence_data JSONB,           -- [{index, english, korean, paragraph}]
  category VARCHAR(50),          -- master_questions.topic_category
  topic VARCHAR(100),            -- master_questions.topic
  created_at TIMESTAMPTZ
)

-- ai_training_packages (패키지)
ai_training_packages (
  id UUID PRIMARY KEY,
  user_id UUID,
  script_id UUID,
  status VARCHAR(20),            -- 'processing' | 'completed' | 'failed'
  wav_file_path TEXT,
  pdf_file_path TEXT,
  json_file_path TEXT,
  timestamp_data JSONB,          -- [{text, start, end}]
  created_at TIMESTAMPTZ
)
```

---

## 10. 내 스크립트 모듈 상세

### 개요

생성된 스크립트를 3패널 구조로 관리하고 학습하는 모듈.

### 페이지 구조

```
my-scripts/
├── page.tsx                   # 3패널 메인
└── components/
    ├── Sidebar.tsx            # 카테고리별 스크립트 목록 + 빈도 표시
    ├── LearningView.tsx       # 오디오 재생 + 스크립트 표시
    ├── ScriptDisplay.tsx      # 영어/한글 스크립트 표시
    └── AudioPlayer.tsx        # 문장 동기화 오디오 재생
```

### 데이터 흐름

```
페이지 로드
→ scriptsApi.getStats() + scriptsApi.getList() 병렬 호출
→ analysisApi.getFrequencyAnalysis() (Sidebar에서 빈도 표시)
→ Sidebar: 카테고리별 스크립트 목록
→ 스크립트 선택 → LearningView 렌더링
→ AudioPlayer: timestamp_data 기반 문장 싱크 (가라오케)
→ 문장 반복 모드 지원
```

### 핵심 타입

```typescript
interface MyScript {
  script_id: string;
  package_id: string;
  question_id: string;              // master_questions.question_id
  question_korean: string;          // master_questions.question_korean
  question_english: string;         // master_questions.question_english
  topic: string;                    // master_questions.topic
  category: string;                 // master_questions.topic_category
  final_script: string;             // 영어
  korean_translation: string;
  sentence_data: Array<{
    index: number;
    english: string;
    korean: string;
    paragraph: string;
  }>;
  timestamp_data: Array<{
    text: string;
    start: number;                   // 초
    end: number;
  }>;
  created_at: string;
}
```

### 핵심 API

| API | 용도 |
|-----|------|
| `my-scripts-list` | 스크립트 목록 (카테고리/주제/페이지 필터) |
| `my-scripts-stats` | 통계 (totalScripts, categories) |

---

## 11. 쉐도잉 모듈 상세

### 개요

패키지 기반 4모드 쉐도잉 훈련. Whisper STT + GPT-4 평가.

### 4가지 모드

| 모드 | 설명 | 핵심 기능 |
|------|------|-----------|
| **Listen** | 영어만 듣기 | 자막 선택, playbackSpeed |
| **Training** | 따라읽기 + 평가 | 문장별 shadow → record → evaluate |
| **Assessment** | 종합 평가 | 전체 녹음 → 6개 영역 평가 |
| **Real Test** | 실전 테스트 | 질문만 + 자유 말하기 |

### 데이터 흐름

```
내 스크립트 → 패키지 완료된 질문 → "쉐도잉 훈련" 클릭
→ /shadowing/[packageId]
→ ShadowingMain 컴포넌트 로드
→ Supabase Storage에서 파일 로드 (.wav, .json, .pdf)
→ shadowingStore 초기화
→ 학습 모드 선택
```

### 평가 시스템

```
녹음 → Base64 Data URL 생성
→ Edge Function: shadowing-test-evaluate
→ Whisper STT (음성→텍스트)
→ GPT-4 평가:
  - pronunciation: 0-100
  - fluency: 0-100
  - grammar: 0-100
  - vocabulary: 0-100
  - content: 0-100
  - overall_score: 0-100
  - estimated_level: 'IM3'
  - strengths[], weaknesses[], suggestions[]
  - script_analysis: { key_sentences_used[], missing_elements[] }
```

### Zustand 스토어 (shadowingStore)

```typescript
interface ShadowingV2State {
  packageId: string;
  scriptId: string;
  audioUrl: string;
  sentences: ShadowingSentence[];
  currentMode: 'listen' | 'training' | 'assessment' | 'realtest';

  guideSettings: { enabled, level, showTutorial };
  userStats: { totalSessions, totalSentences, averageScore };

  listenMode: { isPlaying, currentTime, playbackSpeed, scriptDisplay };
  trainingMode: {
    currentIndex, currentPhase: 'shadow' | 'record' | 'evaluate',
    scores: Record<number, { score, attempts }>,
    settings: { shadowCount, trainingMode, autoProgress }
  };
  assessmentMode: { isRecording, attempts[], bestScore };
}
```

### Whisper 고도화 분석

```typescript
interface WhisperEnhancedData {
  phase1: {
    stressPattern: string;
    speedAnalysis: string;
    pronunciationDifficulty: string;
    rhythmPattern: string;
  };
  phase2?: {
    linkingPatterns: string[];
  };
  practiceGuide: {
    beforeRecording: string;
    afterEvaluation: string;
  };
}
```

### 핵심 API

| API | 용도 |
|-----|------|
| `shadowing-test-create` | 세션 생성 (package_id → session_id, sentences[]) |
| `shadowing-test-evaluate` | 음성 평가 (audio_data → 6개 영역 점수) |

### DB 테이블

```sql
-- shadowing_sessions (세션)
shadowing_sessions (
  session_id UUID PRIMARY KEY,
  user_id UUID,
  package_id UUID,
  mode VARCHAR(20),
  created_at TIMESTAMPTZ
)

-- shadowing_attempts (평가 기록)
shadowing_attempts (
  attempt_id UUID PRIMARY KEY,
  session_id UUID,
  sentence_index INT,
  overall_score INT,
  pronunciation INT,
  fluency INT,
  grammar INT,
  vocabulary INT,
  content INT,
  feedback JSONB,
  recorded_at TIMESTAMPTZ
)
```

---

## 12. 공통 인프라

### 인증 시스템 (authStore)

```typescript
interface AuthState {
  user: User | null;
  isLoading: boolean;
  isSignedIn: boolean;
  initAuth(): void;
  signUp(email, password, userDetails): void;
  signIn(email, password): void;
  signOut(): void;
  checkSession(): void;
}
```

### AI 권한 서비스 (AIPermissionService)

```typescript
enum AIFeature {
  AI_TRAINING_GENERATE_SCRIPT,
  WHISPER_STT,
  TTS_PACKAGE,
  GPT_EVALUATION,
  MOCK_TEST
}

class AIPermissionService {
  async checkAndConsume(userId, feature) {
    // 우선순위: subscription > api_key > points > admin
    return {
      allowed: boolean,
      method: 'subscription' | 'api_key' | 'points' | 'admin',
      remainingPoints: number,
      message: string
    };
  }
}
```

### Supabase 클라이언트

- **브라우저**: 싱글톤, 세션 자동 갱신, 탭 간 동기화
- **서버**: cookies 기반 인증
- **미들웨어**: 모든 요청 인증 확인, 세션 갱신

### 공통 Edge Functions

| Function | 용도 |
|----------|------|
| `azure-tts-generate` | Azure TTS (음성 합성) |
| `azure-speech-websocket` | Azure 실시간 음성인식 |
| `whisper-proxy` | OpenAI Whisper STT |
| `convert-audio` | 오디오 변환 |
| `tts-speak` | TTS 재생 |
| `upload` | 파일 업로드 (Supabase Storage) |
| `user-profile` | 사용자 프로필 |
| `user-subscription` | 구독 상태 |

### 공유 API (analysisApi)

```typescript
// 데이터랩 + AI 훈련소 + 내 스크립트에서 공유
analysisApi.getFrequencyAnalysis(year?, limit?)  // 주제별 빈도
analysisApi.getTopicQuestions(topic, category)    // 주제별 질문
```

### 에러 처리

```typescript
// 공통 에러 로거 (모든 Edge Function)
function generateRequestId()
async captureAndRespond(error, context)

// CORS 헤더
corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Authorization, Content-Type'
}
```

---

## 13. DB 스키마 종합

### 이관 테이블 전체 목록

| # | 소리담 테이블 | 오픽톡닥 테이블 | 용도 | 핵심 |
|---|--------------|----------------|------|------|
| 1 | `users` | `profiles` | 사용자 프로필 | |
| 2 | **`master_questions`** | **`master_questions`** | **마스터 질문 DB (510개, 시스템 코어)** | ⭐ |
| 3 | **`custom_mode_questions`** | **`custom_mode_questions`** | **콤보 자동 생성 (DB 트리거)** | ⭐ |
| 4 | `ai_prompts` | `ai_prompts` | AI 프롬프트 관리 | |
| 5 | `submissions` | `submissions` | 데이터랩 후기 제출 | |
| 6 | `submission_questions` | `submission_questions` | 후기 질문 기록 (트리거 발동 지점) | ⭐ |
| 7 | `mock_test_sessions` | `mock_test_sessions` | 모의고사 세션 | |
| 8 | `mock_test_answers` | `mock_test_answers` | 모의고사 답변 | |
| 9 | `mock_test_evaluations_v7` | `mock_test_evaluations` | 개별 평가 (v 제거) | |
| 10 | `mock_test_holistic_evaluations_v7` | `mock_test_holistic_evaluations` | 종합 평가 (v 제거) | |
| 11 | `tutoring_sessions` | `tutoring_sessions` | AI 튜터 세션 | |
| 12 | `tutoring_progress` | `tutoring_progress` | 유형별 진행 | |
| 13 | `tutoring_template_answers` | `tutoring_template_answers` | AI 교정 답변 | |
| 14 | `tutoring_training_attempts` | `tutoring_training_attempts` | 훈련 시도 | |
| 15 | `tutoring_prompts` | `tutoring_prompts` | 튜터링 프롬프트 | |
| 16 | `ai_tutor_skills` | `ai_tutor_skills` | 8대 스킬 + 40개 원인코드 | |
| 17 | `ai_tutor_characters` | `ai_tutor_characters` | Sori & Dam 튜터 | |
| 18 | `ai_tutor_training_modules` | `ai_tutor_training_modules` | 48개 훈련 모듈 | |
| 19 | `ai_training_scripts` | `ai_training_scripts` | AI 생성 스크립트 | |
| 20 | `ai_training_packages` | `ai_training_packages` | TTS/PDF/JSON 패키지 | |
| 21 | `shadowing_sessions` | `shadowing_sessions` | 쉐도잉 세션 | |
| 22 | `shadowing_attempts` | `shadowing_attempts` | 쉐도잉 평가 기록 | |
| 23 | `user_files` | `user_files` | 파일 저장 (Storage) | |

### DB 트리거 / RPC 함수 (이관 필수)

| # | 이름 | 타입 | 용도 |
|---|------|------|------|
| 1 | `process_custom_mode_questions()` | TRIGGER | submission_questions INSERT 시 콤보 자동 생성 |
| 2 | `find_similar_questions_by_frequency()` | RPC | AI 튜터 유사 질문 추천 |

### 미이관 테이블

| 테이블 | 사유 |
|--------|------|
| `mock_test_evaluations_v4/v6` | v7로 대체 |
| `mock_test_holistic_evaluations_v6` | v7로 대체 |
| `ai_tutor_v3_*` (5개) | V1 기반으로 통합 |
| `board_posts` | 게시판 미포함 |
| `talklish_*` | 톡리시 미포함 |

---

## 14. Edge Functions 종합

### 이관 대상 (약 42개)

#### 데이터랩 (7개)
| Function | 용도 |
|----------|------|
| `data-lab-stats` | 전체 통계 |
| `data-lab-reviews` | 후기 목록 |
| `analysis-frequency` | 빈도 분석 |
| `analysis-topic-questions` | 주제별 문제 |
| `submissions-step1/2/3` | 3단계 제출 |
| `submissions-my` | 내 후기 목록 |
| `submissions-detail` | 후기 상세 |

#### 모의고사 (12개)
| Function | 용도 |
|----------|------|
| `mock-test-create-v2` | 세션 생성 (콤보 기반, 최종) |
| `mock-test-submit-v2` | 답변 제출 (최종) |
| `mock-test-process-v7` | V7 평가 + 규칙엔진 |
| `mock-test-status-v7` | 상태 폴링 |
| `mock-test-history-v7` | V7 히스토리 |
| `mock-test-active-session` | 활성 세션 확인 |
| `mock-test-get-session` | 세션 조회 |
| `mock-test-get-answers` | 답변 조회 |
| `mock-test-report-v7` | V7 리포트 |
| `mock-test-generate-tts-batch` | TTS 일괄 |
| `mock-test-combos-list` | 커스텀 모드 콤보 목록 |
| `mock-test-custom-preview` | 콤보별 질문 미리보기 |

#### AI 튜터 (8개)
| Function | 용도 |
|----------|------|
| `tutoring-start` | 세션 생성 |
| `tutoring-get-diagnosis` | 진단 결과 |
| `tutoring-get-progress` | 진행 상태 |
| `tutoring-get-original-answer` | 원본 답변 |
| `tutoring-generate-template-answer` | AI 교정 답변 |
| `tutoring-evaluate-attempt` | 시도 평가 |
| `tutoring-next-question` | 다음 유형 |
| `tutoring-generate-tts` | TTS 생성 |

#### 스크립트 (6개)
| Function | 용도 |
|----------|------|
| `ai-training-generate-script-v6` | 스크립트 생성 |
| `ai-training-refine-script` | 스크립트 수정 |
| `ai-training-generate-package` | 패키지 생성 |
| `ai-training-package-status` | 패키지 상태 |
| `my-scripts-list` | 스크립트 목록 |
| `my-scripts-stats` | 스크립트 통계 |

#### 쉐도잉 (2개)
| Function | 용도 |
|----------|------|
| `shadowing-test-create` | 세션 생성 |
| `shadowing-test-evaluate` | 음성 평가 |

#### 관리자 (1개)
| Function | 용도 |
|----------|------|
| `admin-master-questions` | 마스터 질문 CRUD (관리자 전용) |

#### 공통 인프라 (8개)
| Function | 용도 |
|----------|------|
| `azure-tts-generate` | Azure TTS |
| `azure-speech-websocket` | Azure 실시간 STT |
| `whisper-proxy` | Whisper STT |
| `convert-audio` | 오디오 변환 |
| `tts-speak` | TTS 재생 |
| `upload` | 파일 업로드 |
| `user-profile` | 프로필 |
| `user-subscription` | 구독 상태 |

### master_questions 참조 Edge Functions (69개)

> 총 69개 Edge Function이 master_questions를 직접/간접 참조.
> 이관 대상 42개 중 대부분이 포함되며, 나머지 27개는 레거시/미이관 버전.

---

## 15. 오픽톡닥 이관 시 주의사항

### 핵심 코어 이관 (최우선)

- **master_questions 510개 시드 데이터** → 오픽톡닥에 그대로 이관
- **question_id 코드 시스템** 유지 (FK 참조 무결성)
- **answer_type 10가지** 정확히 이관 (세분화된 past_experience 3종, advanced 2종 포함)
- **custom_mode_questions** 테이블 + DB 트리거 + RPC 함수 함께 이관
- **audio_url** 경로 매핑 (소리담 Storage → 오픽톡닥 Storage)

### DB 버전 정리
- 소리담 평가: v4/v6/v7 혼재 → **오픽톡닥: v7 기반, 버전 접미사 제거**
- AI 튜터: v1/v2/v3 혼재 → **오픽톡닥: v3 기반, 버전 접미사 제거**
- 예: `mock_test_evaluations_v7` → `mock_test_evaluations`

### Edge Functions 정리
- 소리담: 400+개 → **오픽톡닥: ~42개만 선별**
- 버전별 중복 제거 (process-v3/v4/v6/v7 → v7만)
- 오픽톡닥에서 함수명 통일 (v7 접미사 제거)

### 프론트엔드 정리
- Tailwind 3.x → 4.x 마이그레이션
- 소리담 UI → 오픽톡닥 브랜드 디자인
- 베타 테스터/관리자 분기 로직 제거 (V7만 사용)
- V4/V6 레거시 코드 제거

### 권한 시스템 변경
- 소리담: 베타 테스터/관리자/톡리시 멤버 분기
- 오픽톡닥: 구독 기반 통합 권한 (무료/베이직/프리미엄)
- AIPermissionService 재설계 필요

### 모의고사 ↔ AI 튜터 연동
- `mock_test_evaluations_v7` → `tutoring_sessions` (FK 참조)
- 체크박스 Before/After 추적 체계 유지
- FACT 점수 계산 로직 프론트엔드에 있음 (백엔드 이관 검토)

### 스토리지
- 소리담: Supabase Storage + Cloudflare R2
- 오픽톡닥: Supabase Storage 통일 검토
- 음성 파일 (WAV), PDF, JSON 파일 관리
- master_questions audio_url 경로 재매핑 필요

### 외부 서비스 의존성
- **OpenAI**: GPT-4 (평가/생성), Whisper (STT)
- **Azure**: TTS (음성 합성), Speech Service (발음 평가)
- **Google Gemini**: TTS (Aoede 음성, master_questions 음성 생성)
- 오픽톡닥에서 API 키/계정 별도 준비 필요

---

*최종 업데이트: 2026-02-19*
*상태: 코드 레벨 상세 분석 완료 (master_questions 핵심 코어 + custom_mode_questions 데이터 파이프라인 보강)*
*다음 단계: DB 스키마 설계 (데이터랩 모듈부터)*
