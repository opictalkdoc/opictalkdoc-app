# 오픽톡닥 의사결정 기록

> **목적**: 제품/기술 의사결정을 한 곳에서 관리. 상세 설계는 `설계/` 폴더 참조.
> **최종 업데이트**: 2026-02-22

---

## 결정 요약 (Quick Reference)

### 제품 의사결정

| # | 주제 | 결정 | 결정일 |
|---|------|------|--------|
| P-1 | 등급 설정 방식 | 넛지 배너(전 페이지) + 인라인 모달(현재/목표 등급) | 2026-02-21 |
| P-2 | 후기 보상 체계 | 크레딧 보상 (1건=스크립트 2회, 월 2건 제한) | 2026-02-21 |
| P-3 | 대시보드 학습 현황 | 점진 확장 (1단계: 크레딧+등급 → 2단계: 로드맵+활동 → 3단계: 차트+분석) | 2026-02-21 |
| P-4 | 브랜딩 네이밍 | 이름 유지(가칭) + 컨셉: "나는 내 삶의 주인공이다" (무대 메타포) | 2026-02-21 |

### 기술 의사결정 — 공통

| # | 주제 | 결정 | 결정일 |
|---|------|------|--------|
| T-1 | FK 전략 | 단일 값=FK 필수, 배열+불변=FK 생략, 삭제: CASCADE/RESTRICT | 2026-02-20 |
| T-2 | ENUM/CHECK 전략 | 값 확정=ENUM, 변경 가능=CHECK 제약 | 2026-02-20 |
| T-3 | 트리거 원칙 | 단순 작업만(updated_at, user_sync). 비즈니스 로직은 백엔드로 | 2026-02-20 |
| T-4 | CORS 정책 | opictalkdoc.com + www + localhost:3000만 허용 | 2026-02-20 |
| T-5 | 포인트 시스템 | 삭제 → 횟수제 전환 (플랜별 사용 횟수 제한) | 2026-02-20 |
| T-6 | Edge Function 구조 | 모듈별 1개 함수 + handlers/ 분리. 44개→6~8개 | 2026-02-20 |
| T-7 | 테이블 버전 접미사 | v 접미사 없이 진행 | 2026-02-20 |
| T-8 | 백엔드 아키텍처 | Server Components + Server Actions (표준). Edge Function 사용 안 함 | 2026-02-22 |
| T-9 | 하이브리드 백엔드 | Server Actions(CRUD) + Edge Functions(AI API 호출). T-8 수정 | 2026-02-23 |

### 기술 의사결정 — 모듈별

| 모듈 | 핵심 결정 | 상세 설계 |
|------|----------|----------|
| 시험후기 | submissions + submission_questions + submission_combos 3테이블. 콤보 생성은 Step 3 완료 시 | → `설계/시험후기.md` |
| 모의고사 | 5테이블 (queue→answers 통합). V7 규칙엔진 이관. Realtime 구독 | → `설계/모의고사.md` |
| 스크립트 | scripts 통합 테이블 (생성+교정 공유). RCTF 프롬프트 1개로 통일. PDF 제거 | → `설계/스크립트.md` |
| 튜터링 | 6테이블. 4레벨 재설계 (드래그앤드롭→읽기, 쉐도잉 추가). 복습 스케줄 신규 | → `설계/튜터링.md` |
| 쉐도잉 | 2테이블. scripts/에 통합. Listen/Training은 클라이언트 완결 | → `설계/쉐도잉.md` |

### 이관 사전 결정

| # | 주제 | 결정 | 결정일 |
|---|------|------|--------|
| M-1 | custom_mode_questions | 삭제 후 이관 시 재생성 | 2026-02-22 |
| M-2 | 백엔드 방식 | Server Components + Server Actions (= T-8) | 2026-02-22 |
| M-3 | 소리담 데이터 이관 | ⏳ 논의 중 | - |
| M-4 | 후기 공개/비공개 | **전체 공개** (complete 상태 = 기출+설문+후기 공개) | 2026-02-22 |

---

## Part A: 제품 의사결정

### P-1. 등급 설정 방식 ✅

**핵심 질문**: 사용자가 등급 설정을 모를 수 있다. 어떻게 유도할 것인가?

**결정 (2026-02-21)**:
- **넛지 배너**: 등급 미설정 시 전 페이지 상단에 안내 배너
- **인라인 모달**: 배너의 [설정하기] 클릭 → 그 자리에서 현재 등급 + 목표 등급 설정
- 시험 예정일은 마이페이지에서 별도 설정
- 데이터: `user_metadata`의 `target_grade` + `current_grade`

**구현 상태**: ✅ 완료 (GradeNudgeBanner + GradeSettingModal)

---

### P-2. 시험후기 보상 체계 ✅

**핵심 질문**: 시험후기 제출 시 어떤 보상을 줄 것인가?

**선택지 비교**:

| 안 | 방식 | 장점 | 단점 |
|----|------|------|------|
| A | 크레딧 보상 | 즉시 체감, 기존 시스템 활용 | 남용 가능 |
| B | 기능 해금 | 크레딧 경제 무영향 | 보상 체감 느림 |
| C | 포인트/배지 | 장기 리텐션 | 실질 보상 부족 |
| D | 혼합 | 즉시+장기 | 구현 복잡 |

**결정 (2026-02-21)**: A안 — 크레딧 보상
- 1건 제출 = 스크립트 크레딧 2회 (`script_credits` 영구)
- 월 2건 제한 (월 최대 4회 획득)
- 동일 시험일 중복 불가, 필수 입력 3개 이상

**구현 상태**: ✅ 완료 (completeSubmission 내 increment_script_credits RPC 호출)

---

### P-3. 대시보드 학습 현황 ✅

**핵심 질문**: 어떤 학습 지표를 어떤 방식으로 보여줄 것인가?

**결정 (2026-02-21)**: 점진 확장

| 단계 | 시점 | 내용 |
|------|------|------|
| 1단계 | Phase 3 현재 | 플랜 & 크레딧 + 목표 등급 & D-day + 모듈 바로가기 |
| 2단계 | 핵심 모듈 이관 후 | 학습 로드맵 진행률 + 최근 활동 + streak |
| 3단계 | 전체 완성 후 | 점수 추이 차트 + 약점 분석 + 통계 |

**구현 상태**: ✅ 1단계 완료

---

### P-4. 브랜딩 ✅

**핵심 질문**: "오픽톡닥"이 핵심 가치를 잘 전달하는가?

**결정 (2026-02-21)**:
- **이름**: "오픽톡닥" 가칭 유지 (인프라 변경 없음)
- **컨셉**: "나는 내 삶의 주인공이다"
- **메타포**: 무대/연극 (대본, 조명, 명대사, 리허설, 디렉팅)
- **태그라인**: "말하다, 나답게."

**적용 내용**:
- 히어로 섹션: 메인 선언문 ("화려한 필터는 끄세요...")
- 서비스 소개 01~05: 무대 메타포 버전
- 운영자의 편지 섹션

**구현 상태**: ✅ 랜딩 페이지 전면 교체 완료

---

## Part B: 아키텍처 리뷰 — 소리담 문제점 (15개)

> 소리담 현황: DB 23개+, Edge Functions 44개, 트리거 3개, RPC 2개

### A. DB 설계 문제 (6개)

| # | 문제 | 위험도 | 결정 |
|---|------|--------|------|
| A-1 | FK 제약 없음 | 높음 | 단일값=FK 필수, 배열+불변=FK 생략 (→ T-1) |
| A-2 | VARCHAR 상태 필드 | 중간 | 확정=ENUM, 변경가능=CHECK (→ T-2) |
| A-3 | 트리거에 비즈니스 로직 | 높음 | 백엔드로 이전 (→ T-3) |
| A-4 | 하드코딩 제외 규칙 | 중간 | A-3과 함께 해결 — 코드에서 관리 |
| A-5 | 콤보 저장 이중화 | 중간 | submission_combos 하나로 통합, custom_mode_questions 제거 |
| A-6 | JSONB 과다 사용 | 낮음 | question_id 배열만 저장, JOIN으로 조회 |

### B. 아키텍처 문제 (5개)

| # | 문제 | 위험도 | 결정 |
|---|------|--------|------|
| B-1 | FACT 점수 계산이 프론트 | 높음 | 백엔드로 이전 (V7에서 이미 적용) |
| B-2 | Fire-and-Forget 리포트 | 중간 | Retry + backoff + Dead Letter 패턴 |
| B-3 | CORS `*` 허용 | 중간 | 허용 도메인 제한 (→ T-4) |
| B-4 | 포인트 시스템 분산 | 중간 | 포인트 삭제 → 횟수제 (→ T-5) |
| B-5 | 테이블명 버전 접미사 | 낮음 | 접미사 없이 진행 (→ T-7) |

### C. 데이터 플로우 문제 (4개)

| # | 문제 | 위험도 | 결정 |
|---|------|--------|------|
| C-1 | Edge Function 44개 과다 분리 | 중간 | 모듈별 1개로 통합 (→ T-6) |
| C-2 | 상태 폴링 2초 간격 | 낮음 | Supabase Realtime + 폴링 폴백 |
| C-3 | AI API 비용 비효율 | 중간 | V7 이미 최적화 완료, 기존 방식 유지 |
| C-4 | 논리적 FK만 존재 (배열) | 높음 | A-1 + A-5로 해결 |

---

## Part C: 이관 사전 결정

### M-1. custom_mode_questions 테이블 ✅

**결정 (2026-02-22)**: 삭제 후 이관 시 재생성
- DB Step 0에서 미리 생성했으나 submissions 없이 단독 존재
- 삭제 완료 — submissions, submission_questions, submission_combos 3개를 함께 설계

### M-2. 백엔드 아키텍처 ✅ → T-9으로 수정

**결정 (2026-02-22)**: Server Components + Server Actions
**수정 (2026-02-23)**: 하이브리드 — T-9 결정 적용

| 기능 | 방식 |
|------|------|
| 데이터 조회 | Server Component에서 Supabase 직접 조회 |
| 데이터 변경 (CRUD) | Server Action (`'use server'`) |
| AI API 호출 (GPT, STT, TTS 등) | **Edge Functions** (Supabase) |
| 외부 콜백/웹훅 | API Routes (기존 유지) |

> 시험후기 모듈은 Server Actions만으로 완료. 스크립트/모의고사/튜터링은 AI 호출 부분을 Edge Functions로 구현 예정.

### T-9. 하이브리드 백엔드 전략 ✅

**핵심 질문**: Server Actions만 쓸 것인가, Edge Functions도 활용할 것인가?

**배경 (T-8 재검토)**:
- T-8에서 "Edge Functions 사용 안 함"으로 결정했으나, 실제 모듈 분석 결과 AI API 호출(GPT, Whisper, Gemini TTS, Azure Speech)이 다수 존재
- 이런 AI 작업은 10~60초 이상 소요 → Vercel Hobby 서버리스 함수 제한(10초)에 걸릴 수 있음
- Supabase Pro($25)에 Edge Functions 무료 포함 → 추가 비용 없음

**결정 (2026-02-23)**: 하이브리드 — 작업 성격에 따라 분리

| 작업 성격 | 백엔드 방식 | 예시 |
|----------|-----------|------|
| **가벼운 CRUD** | Server Actions | DB 읽기/쓰기, 세션 관리, 목록/상세 조회 |
| **무거운 AI API** | Edge Functions | GPT 생성/채점, Whisper STT, Gemini TTS, Azure 발음 |

**모듈별 적용 계획**:

| 모듈 | Server Actions | Edge Functions |
|------|---------------|----------------|
| 시험후기 | 전부 (DB CRUD만) | 없음 |
| 스크립트 | 목록/상세/삭제 CRUD | GPT 스크립트 생성, Gemini TTS 패키지, Whisper 쉐도잉 평가 |
| 모의고사 | 세션 생성, 답변 제출, 상태 조회 | Whisper STT + Azure 발음 평가, GPT 체크박스 채점, 리포트 생성 |
| 튜터링 | 세션/진행/복습/성장 CRUD | GPT 교정 스크립트, Whisper STT + GPT 레벨별 평가 |

**비용 영향**: 없음 (Vercel Hobby $0 + Supabase Pro $25 = 기존과 동일)

**T-8과의 관계**: T-8을 완전히 폐기하지 않고, CRUD 부분은 Server Actions 유지. AI 호출만 Edge Functions로 분리.

---

### M-3. 소리담 기존 후기 데이터 이관 ⏳

**현황**: 오픽톡닥 후기 0건, 소리담에 기존 데이터 존재
**결정**: 논의 중

### M-4. 후기 공개/비공개 ✅

**핵심 질문**: 완료된 시험후기를 다른 사용자에게 공개할 것인가?

**결정 (2026-02-22)**: **전체 공개**
- `status='complete'`인 후기는 모든 사용자에게 공개
- `is_public` 필드 없음 (소리담과 달리 완료 = 공개)

**공개 내용**:
- 기출 문제 14개 (`submission_questions`) — 어떤 시험이 나왔는지 즉각 공유
- 설문 응답 9개 (시험 배경 4 + 체감 후기 3 + 시험 기본 정보 2)
- 자유 후기 (한줄 후기 + 팁/조언)

**설문 항목 설계 (9개)** — 통계 자료 활용 목적:
- Step 1 시험 배경: 시험 목적, 공부 방법(복수선택), 준비 기간, 응시 횟수
- Step 1 체감 후기: 체감 난이도, 시간 여유, 실제 소요 시간
- Step 3 자유 후기: 한줄 후기(100자 필수), 팁/조언(300자 선택)

→ 상세 설계: `설계/시험후기.md`

---

## 구현 현황

| # | 작업 | 상태 | 비고 |
|---|------|------|------|
| 1 | 랜딩 페이지 브랜딩 업데이트 (P-4) | ✅ 완료 | Hero/Features/편지/Footer/CTA 전면 교체 |
| 2 | 넛지 배너 + 등급 설정 모달 (P-1) | ✅ 완료 | GradeNudgeBanner + GradeSettingModal |
| 3 | 대시보드 실데이터 연동 (P-3, 1단계) | ✅ 완료 | user_credits + user_metadata 연동 |
| 4 | 시험후기 보상 체계 (P-2) | ✅ 완료 | completeSubmission 내 크레딧 보상 구현 |
| 5 | 시험후기 모듈 이관 (Step 1) | ✅ 완료 | DB 3테이블 + Server Actions 12개 + UI 위저드 3단계 + 빈도분석 + 공개후기 |
| 6 | 하이브리드 백엔드 전략 (T-9) | ✅ 결정 | Server Actions(CRUD) + Edge Functions(AI) |

---

## 분석 과정 기록

> 설계 결정의 근거가 된 소리담 코드 분석 과정. 재현 가능하도록 기록.

### 소리담 프로젝트 위치
```
C:\Users\js777\Desktop\soridam
```

### 분석 대상 (단계별)

| 단계 | 대상 | 핵심 파일 |
|------|------|----------|
| 1. 공통 기반 | 전체 | migrations/*.sql, functions/*/index.ts, types/*.ts |
| 2. 시험후기 | submissions | submission-*/ 6개+ Edge Function, datalab/ 컴포넌트 |
| 3. 모의고사 | mock test | mock-test-*/ 18개 함수, ruleEngine/ 서비스 |
| 4. 스크립트 | scripts | ai-training-*/ 13개 함수, script_prompt_templates |
| 5. AI 튜터 | tutoring | tutoring-*/ 10개 함수, V1/V2/V3 혼재 |
| 6. 쉐도잉 | shadowing | shadowing-test-*/ 3개 함수, sentenceWordMatcher.ts |

### 사용자 결정이 설계를 바꾼 주요 순간

| 사용자 발언 | 기존 설계 | 변경 |
|-----------|----------|------|
| "평가가 2~3분 걸리는데?" | 폴링 | Supabase Realtime |
| "이미 V7까지 최적화 됨" | 배치/캐싱 도입 | 기존 V7 유지 |
| "튜터링 교정 프롬프트가 가장 최근" | 스크립트 프롬프트 기반 | 튜터링 RCTF 기반 |
| "1가지 방식으로. 튜터링과 동일" | 3가지 생성 방식 | RCTF 1개 통일 |
| "완성작이 아니야, 추천해줘" | V1 그대로 이관 | 4레벨 재설계 + 쉐도잉 추가 |
| "서로 공유할꺼야" | template_answers 별도 | scripts 통합 |
| "pdf 생성은 없애자" | WAV+PDF+JSON | WAV+JSON |
| "기출 문제랑 실제 후기를 같이 공개" | is_public 필드 (선택) | complete = 전체 공개 (M-4) |
| "통계 자료로 활용할 수 있는 내용" | 자유 서술 후기 | 구조화 설문 9개 + 자유 후기 |
| "시험 목적, 공부 방법 이런것도" | 서베이 필드 8개 | 통계용 설문 7개로 재설계 |
| "엣지 펑션으로 개발 했으면 됐잖아" | Server Actions 전면 사용 | 하이브리드: CRUD=SA, AI=EF (T-9) |

---

*최종 업데이트: 2026-02-23*
