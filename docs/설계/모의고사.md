# 모의고사 모듈 설계

> 의사결정 근거는 [docs/의사결정.md](../의사결정.md) 참조
> - A-6: question_ids TEXT[] 방식
> - B-1: V7 평가 → 체크박스 + 규칙엔진
> - B-2: 리포트 생성 흐름 + 재시도
> - B-4: 구독 횟수 체크
> - B-5: _v7 접미사 제거
> - C-1: Edge Function 통합
> - C-2: Realtime 상태 관리

---

## 테이블 설계 (4개 + 설정 1개)

### mock_test_sessions (세션 관리)

```sql
CREATE TABLE mock_test_sessions (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id      TEXT UNIQUE NOT NULL,        -- 'mt_xxxxxxxx'
  user_id         UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  mode            TEXT NOT NULL CHECK (mode IN ('frequent','recent','custom')),
  status          TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','completed','expired')),
  question_ids    TEXT[] NOT NULL,              -- A-6: question_id 배열만, JOIN으로 조회
  current_question SMALLINT DEFAULT 1,
  total_questions  SMALLINT DEFAULT 15,
  metadata        JSONB,                        -- recent 모드: used_combo_ids 등
  holistic_status TEXT DEFAULT 'pending' CHECK (holistic_status IN ('pending','processing','completed','failed')),
  report_retry_count SMALLINT DEFAULT 0,        -- B-2: 최대 3회 재시도
  report_error    TEXT,
  started_at      TIMESTAMPTZ DEFAULT NOW(),
  completed_at    TIMESTAMPTZ,
  expires_at      TIMESTAMPTZ                   -- 생성 후 24시간
);
```
- 인덱스: (user_id, status), expires_at
- A-6 반영: questions JSONB → question_ids TEXT[] (master_questions JOIN으로 조회)

### mock_test_answers (답변 + 평가 큐 통합)

```sql
CREATE TABLE mock_test_answers (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id      TEXT NOT NULL REFERENCES mock_test_sessions(session_id) ON DELETE CASCADE,
  question_number SMALLINT NOT NULL,
  question_id     TEXT NOT NULL,
  audio_url       TEXT,
  audio_duration  NUMERIC(8,2),
  transcript      TEXT,
  word_count      INTEGER,
  filler_word_count INTEGER DEFAULT 0,
  long_pause_count  INTEGER DEFAULT 0,
  pronunciation_assessment JSONB,
  eval_status     TEXT DEFAULT 'pending' CHECK (eval_status IN ('pending','processing','stt_completed','evaluating','completed','failed','skipped')),
  eval_retry_count SMALLINT DEFAULT 0,          -- B-2: 재시도 횟수
  eval_error      TEXT,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(session_id, question_number)
);
```
- 소리담의 mock_test_queue 테이블을 answers에 통합 (eval_status로 상태 관리)

### mock_test_evaluations (개별 문항 평가)

```sql
CREATE TABLE mock_test_evaluations (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id      TEXT NOT NULL,
  user_id         UUID NOT NULL REFERENCES auth.users(id),
  question_number SMALLINT NOT NULL,
  question_id     TEXT NOT NULL,
  answer_type     TEXT NOT NULL,
  checkbox_type   TEXT CHECK (checkbox_type IN ('INT','ADV','AL')),
  checkbox_count  SMALLINT,
  checkboxes      JSONB,                       -- {체크박스ID: {pass, evidence}}
  pass_count      SMALLINT,
  fail_count      SMALLINT,
  pass_rate       NUMERIC(5,4),
  sentences       JSONB,
  corrections     JSONB,
  deep_analysis   JSONB,
  corrected_script JSONB,
  transcript      TEXT,
  wpm             NUMERIC(6,2),
  audio_duration  NUMERIC(8,2),
  filler_count    SMALLINT,
  long_pause_count SMALLINT,
  pronunciation_assessment JSONB,
  model           TEXT,
  prompt_version  TEXT DEFAULT 'v7.0',
  tokens_used     INTEGER,
  processing_time_ms INTEGER,
  skipped         BOOLEAN DEFAULT false,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(session_id, question_number)
);
```
- B-5 반영: _v7 접미사 없음

### mock_test_reports (종합 평가)

```sql
CREATE TABLE mock_test_reports (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id      TEXT UNIQUE NOT NULL,
  user_id         UUID NOT NULL REFERENCES auth.users(id),
  -- 규칙 엔진 결과
  final_level     TEXT,                        -- NH|IL|IM1|IM2|IM3|IH|AL
  floor_status    TEXT,
  floor_level     TEXT,
  ceiling_status  TEXT,
  sympathetic_listener TEXT,
  -- 체크박스 집계
  int_pass_rate   NUMERIC(5,4),
  adv_pass_rate   NUMERIC(5,4),
  al_pass_rate    NUMERIC(5,4),
  valid_question_count SMALLINT,
  aggregated_int_checkboxes JSONB,
  aggregated_adv_checkboxes JSONB,
  aggregated_al_checkboxes  JSONB,
  al_judgment     TEXT,
  q12_gatekeeper  TEXT,
  skipped_questions JSONB,
  -- 상태 관리 (B-2 반영)
  rule_engine_status TEXT DEFAULT 'pending' CHECK (rule_engine_status IN ('pending','completed','failed')),
  report_status   TEXT DEFAULT 'pending' CHECK (report_status IN ('pending','processing','completed','failed')),
  -- FACT 점수
  score_f         NUMERIC(4,1),
  score_a         NUMERIC(4,1),
  score_c         NUMERIC(4,1),
  score_t         NUMERIC(4,1),
  total_score     NUMERIC(5,1),                -- (F+A+C+T) * 2.5 = 100점 만점
  -- 리포트 피드백
  overall_comments_en TEXT,
  overall_comments_ko TEXT,
  int_performance     JSONB,
  adv_performance     JSONB,
  comprehensive_feedback TEXT,
  training_recommendations JSONB,
  -- 발음 통계
  avg_accuracy_score  NUMERIC(5,1),
  avg_prosody_score   NUMERIC(5,1),
  avg_fluency_score   NUMERIC(5,1),
  -- 메타데이터
  target_level    TEXT,
  test_date       DATE,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  updated_at      TIMESTAMPTZ DEFAULT NOW()
);
```
- B-5 반영: holistic_evaluations_v7 → mock_test_reports

### mock_test_eval_settings (관리자 설정 -- 단일 행)

```sql
CREATE TABLE mock_test_eval_settings (
  id              INTEGER PRIMARY KEY DEFAULT 1,
  prompt_mode     TEXT DEFAULT 'original' CHECK (prompt_mode IN ('original','eval_only','parallel')),
  model_name      TEXT DEFAULT 'gpt-4.1',
  temperature     NUMERIC(3,2) DEFAULT 0.30,
  max_tokens      INTEGER DEFAULT 10000,
  retry_count     INTEGER DEFAULT 2,
  -- answer_type별 활성화 토글
  enabled_description    BOOLEAN DEFAULT true,
  enabled_routine        BOOLEAN DEFAULT true,
  enabled_roleplay_11    BOOLEAN DEFAULT true,
  enabled_comparison     BOOLEAN DEFAULT true,
  enabled_past_experience BOOLEAN DEFAULT true,
  enabled_roleplay_12    BOOLEAN DEFAULT true,
  enabled_advanced_14    BOOLEAN DEFAULT true,
  enabled_advanced_15    BOOLEAN DEFAULT true,
  updated_at      TIMESTAMPTZ DEFAULT NOW()
);
```

---

## Edge Function 구조 (1개)

```
supabase/functions/mock-test/
├── index.ts                        ← 라우팅
├── handlers/
│   ├── create-session.ts           ← 세션 생성 + 15문제 출제
│   ├── submit-answer.ts            ← 답변 제출 + Storage 업로드
│   ├── process-answer.ts           ← Stage A: Whisper STT + Azure 발음
│   ├── evaluate-answer.ts          ← Stage B: GPT-4.1 체크박스 평가
│   ├── generate-report.ts          ← 규칙엔진 실행 + 리포트 생성
│   ├── get-status.ts               ← 평가 진행 상태 조회
│   ├── get-session.ts              ← 세션 상세 / 답변 / 평가 조회
│   ├── get-history.ts              ← 이력 목록
│   ├── skip-question.ts            ← 문항 스킵
│   └── combo-list.ts               ← 커스텀 모드 콤보 목록
├── utils/
│   ├── rule-engine.ts              ← V7 규칙 엔진 (B-1: 등급 판정 백엔드)
│   ├── question-generator.ts       ← 15문제 생성 로직 (frequent/recent/custom)
│   ├── checkbox-definitions.ts     ← INT(18)/ADV(38)/AL(6) 체크박스 정의
│   └── skip-detector.ts            ← 3단계 스킵 판정 (15초/15자/환청)
```

---

## 평가 플로우 (2단계 아키텍처 유지)

```
[답변 제출]
  → submit-answer: Storage 업로드 + answers INSERT (eval_status='pending')
  → fire-and-forget: process-answer 호출

[Stage A] process-answer (~70초)
  → Whisper STT → Azure 발음 평가
  → answers UPDATE (transcript, pronunciation, eval_status='stt_completed')
  → fire-and-forget: evaluate-answer 호출

[Stage B] evaluate-answer (~100초)
  → GPT-4.1 체크박스 평가
  → evaluations INSERT
  → answers UPDATE (eval_status='completed')
  → Q15 완료 시: 규칙 엔진 동기 실행 + generate-report fire-and-forget

[재시도 로직] (B-2 반영)
  → 실패 시 eval_retry_count++ (최대 3회)
  → backoff: 1초 → 2초 → 4초
  → 최종 실패: eval_status='failed' + eval_error 기록
```

---

## 규칙 엔진 등급 판정 (rule-engine.ts)

소리담 V7 로직 그대로 이관:

```
Step 1: 체크박스 집계 (INT/ADV/AL 통과율 계산, 누적 로직 적용)
Step 2: Floor 판정 (INT 통과율 → NH/IL/IM1/IM2/IM3)
Step 3: Ceiling 판정 (ADV 통과율 → BROKE_DOWN/RESPOND/SUSTAIN)
Step 4: Sympathetic Listener (발음 + ADV-5 복합 점수)
Step 5: Q12 게이트키퍼 (롤플레이 12번 ADV-4 통과율)
Step 6: AL 판정 (AL 게이트키퍼 + 통과율)
Step 7: 최종 등급 결합
```
- B-1 반영: 이미 V7에서 백엔드 처리, 그대로 유지

---

## 상태 모니터링 (C-2 반영)

```
폴링 → Supabase Realtime 구독으로 변경

프론트엔드:
  supabase.channel('mock-test-status')
    .on('postgres_changes', {
      event: 'UPDATE',
      table: 'mock_test_answers',
      filter: `session_id=eq.${sessionId}`
    }, (payload) => {
      // eval_status 변경 감지 → 진행률 업데이트
    })
    .on('postgres_changes', {
      event: 'UPDATE',
      table: 'mock_test_sessions',
      filter: `session_id=eq.${sessionId}`
    }, (payload) => {
      // holistic_status 변경 감지 → 리포트 완료 알림
    })

폴백: Realtime 연결 실패 시 5초 간격 폴링
```

---

## 체크박스 구조 요약

| answer_type | checkbox_type | 개수 | 적용 문항 |
|---|---|---|---|
| description | INT | 18 | 자기소개, 설명형 |
| routine | INT | 18 | 루틴/습관 |
| roleplay_11 | INT | 20 | 11-13번 롤플레이 (+INT-3) |
| comparison | ADV | 38 | 비교 |
| past_experience | ADV | 38 | 과거 경험 |
| roleplay_12 | ADV | 42 | 12번 특수 롤플레이 (+ADV-4) |
| advanced_14 | AL | 6 | 14번 어드밴스 |
| advanced_15 | AL | 6 | 15번 어드밴스 |

---

## 소리담 대비 변경 요약

| 항목 | 소리담 | 오픽톡닥 |
|------|--------|----------|
| 테이블명 | _v7 접미사 | 접미사 없음 (B-5) |
| sessions.questions | JSONB (15문제 전체) | TEXT[] question_ids (A-6) |
| 평가 큐 | mock_test_queue 별도 테이블 | answers.eval_status 통합 |
| 종합 평가 | holistic_evaluations_v7 | mock_test_reports |
| 포인트 차감 | AIPermissionService 포인트 | 구독 횟수만 체크 (B-4) |
| 상태 모니터링 | 2초 폴링 | Supabase Realtime + 폴링 폴백 (C-2) |
| 재시도 | 기본 retry | backoff 1→2→4초, 최대 3회, failed 기록 (B-2) |
| Edge Function | 18개 | 1개 mock-test/ (C-1) |
| 규칙 엔진 | V7 그대로 | 그대로 이관 (B-1 이미 적용) |

---

*최종 업데이트: 2026-02-22*
