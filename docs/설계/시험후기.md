# 시험후기 모듈 설계

> **이 문서 하나만 보면 시험후기 모듈을 구현할 수 있다.**
> 소리담 원본 구현 → 오픽톡닥 변경 사항 → 실제 구현 설계 순서로 읽으면 된다.

> **의사결정 근거**: [docs/의사결정.md](../의사결정.md) 참조
> - T-1 (FK 전략), T-2 (ENUM/CHECK), T-3 (트리거 원칙), T-5 (횟수제)
> - A-3 (트리거→함수), A-4 (제외 규칙), A-5 (콤보 통합), B-4 (포인트 삭제)
> - P-2 (후기 보상 체계), M-1 (custom_mode_questions 삭제), M-2 (Server Actions)
> - M-4 (후기 공개: 기출 문제 + 설문 + 자유 후기 전체 공개)

---

## Part A: 소리담 원본 구현

> 소리담 소스: `C:\Users\js777\Desktop\soridam`

### 소리담 페이지 구조

```
data-lab/
├── page.tsx                      # 메인 대시보드 (통계 카드)
├── analysis/page.tsx             # 출제 빈도 분석 (카테고리별 탭)
├── reviews/page.tsx              # 공개 후기 목록 (등급별 분포 + 카드)
└── submissions/
    ├── new/page.tsx              # 후기 제출 위저드 (Step 1→2→3)
    ├── my-list/page.tsx          # 내 제출 목록
    ├── [id]/page.tsx             # 후기 상세보기
    └── [id]/complete/page.tsx    # 제출 완료 페이지
```

### 소리담 DB 테이블 (4개)

#### submissions (23개 컬럼)

```sql
submissions (
  id              UUID PRIMARY KEY,
  user_id         UUID FK → auth.users(id),
  status          VARCHAR(50),     -- 'draft' | 'complete' | 'rejected'
  step_completed  INTEGER DEFAULT 1,
  exam_date       DATE,
  exam_difficulty  VARCHAR(50),    -- "5-5", "6-6" 등 (시작-재조정 난이도)
  achieved_level   VARCHAR(50),    -- OPIc 등급 (AL, IH, IM3, IM2, IM1, IL, NH, NM, NL)
  grade_before_exam VARCHAR(50),   -- 시험 전 보유 등급
  -- 배경설문 (used_recommended_survey=false일 때만 값 저장)
  used_recommended_survey BOOLEAN DEFAULT false,
  survey_occupation TEXT,          -- 직업 분야
  survey_student    TEXT,          -- 학생 여부
  survey_course     TEXT,          -- 수업 이력
  survey_housing    TEXT,          -- 거주 형태
  survey_leisure    TEXT,          -- 여가 활동 (콤마 구분)
  survey_hobbies    TEXT,          -- 취미
  survey_sports     TEXT,          -- 운동
  survey_travel     TEXT,          -- 여행 경험
  -- 후기
  overall_review  TEXT,            -- 전체 후기 (자유 서술)
  tips            TEXT,            -- 팁/조언
  is_survey_based BOOLEAN DEFAULT false,
  submitted_at    TIMESTAMPTZ,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  updated_at      TIMESTAMPTZ DEFAULT NOW()
)
```

- RLS: 본인 조회/생성만 가능
- 공개 후기는 `is_public` 필드 기반 (소리담)

#### submission_questions (9개 컬럼)

```sql
submission_questions (
  id                  SERIAL PRIMARY KEY,
  submission_id       INTEGER FK → submissions(id),
  question_number     INTEGER,           -- 2~15 (1번 자기소개 제외)
  combo_type          VARCHAR(20),       -- '일반콤보1'|'일반콤보2'|'일반콤보3'|'롤플레이'|'어드밴스' (한국어)
  topic               VARCHAR(100),      -- 주제 ("집", "여행", "음식" 등)
  master_question_id  VARCHAR(50) FK → master_questions(question_id),  -- SEL_/COM_ 접두사
  custom_question_text TEXT,             -- 사용자 직접 입력 (NEW: 접두사 제거 후 저장)
  is_not_remembered   BOOLEAN,           -- 기억 못함 체크
  created_at          TIMESTAMP DEFAULT NOW(),
  -- CHECK: 3가지 중 1개 필수
  --   master_question_id 있음 + is_not_remembered=false
  --   custom_question_text 있음 + is_not_remembered=false
  --   is_not_remembered=true + 나머지 NULL
)
```

#### custom_mode_questions (6개 컬럼) — 트리거 자동 생성

```sql
custom_mode_questions (
  id              UUID PRIMARY KEY,
  submission_id   UUID FK → submissions(id),
  combo_category  VARCHAR(100),    -- '일반콤보1'|'일반콤보2'|'일반콤보3'|'롤플레이'|'어드밴스'
  topic           VARCHAR(100),
  question_ids    TEXT[] NOT NULL,  -- master_question_id 배열
  created_at      TIMESTAMP DEFAULT NOW()
)
```

#### submission_combos (6개 컬럼) — 트리거 자동 생성

```sql
submission_combos (
  id              UUID PRIMARY KEY,
  submission_id   UUID FK → submissions(id),
  combo_type      VARCHAR(50),     -- 'General'|'Roleplay'|'Advance' (영문!)
  topic           VARCHAR(100),    -- 토픽들 콤마 연결 ("집,영화,음악")
  question_ids    TEXT[] NOT NULL,
  created_at      TIMESTAMPTZ DEFAULT NOW()
)
```

### 소리담 Edge Functions (16개)

| 함수 | 메서드 | 인증 | 역할 |
|------|--------|------|------|
| `submissions-step1` | POST | 필수 | Step 1: 기본정보+배경설문 → draft INSERT (기존 draft 삭제) |
| `submissions-step2` | POST | 필수 | Step 2: 14개 질문 INSERT → 기존 삭제 후 재삽입 |
| `submissions-step3` | POST | 필수 | Step 3: 후기+완료 → 콤보 추출 → 포인트 +100 |
| `submissions-my` | GET | 필수 | 내 후기 목록 (페이지네이션) |
| `submissions-public` | GET | 불필요 | 공개 후기 목록 (is_public=true, step_completed=3) |
| `submissions-detail` | GET | 선택 | 후기 상세 (master_questions JOIN) |
| `submissions-delete` | DELETE | 필수 | 후기 삭제 (CASCADE) |
| `submissions-delete-draft` | POST | 필수 | draft 일괄 삭제 |
| `submissions-draft` | GET | 필수 | 현재 draft 1개 조회 |
| `submissions-update-grade` | PATCH | 필수 | achieved_level만 수정 |
| `submissions-create` | - | - | 스텁 (미사용) |
| `submissions-admin-list` | GET | 관리자 | 전체 후기 (RLS 우회, 검색) |
| `submissions-admin-delete` | DELETE | 관리자 | 관리자 삭제 (로그 기록) |
| `analysis-frequency` | GET | 선택 | 빈도 분석 (비로그인: 어드밴스만) |
| `analysis-topic-questions` | GET | 선택 | 주제별 출제 질문 목록 |
| `data-lab-stats` | GET | 선택 | 전체 통계 (제출 수, 유니크 질문 수) |

### 소리담 콤보 추출 로직 (`_shared/comboExtractor.ts`)

```
입력: submission_questions 14개

3가지 콤보 타입별 검증:
1. General (2~10번, 9문항): 모두 master_question_id 있고 + is_not_remembered=false + 제외주제 아님
2. Roleplay (11~13번, 3문항): 모두 master_question_id 있고 + is_not_remembered=false
3. Advance (14~15번, 2문항): 모두 master_question_id 있고 + is_not_remembered=false + 제외주제 아님

제외 주제: 공원, 카페, 하이킹 (일반+어드밴스에서만 적용)
조건 미충족 콤보는 생성 안 함 (에러 아님)
콤보 추출 실패해도 후기 자체는 저장됨 (try-catch)

출력: submission_combos에 최대 5개 INSERT
  - General: topic="집,영화,음악", question_ids=[9개]
  - Roleplay: topic="레스토랑", question_ids=[3개]
  - Advance: topic="집에서 보내는 휴가", question_ids=[2개]
```

### 소리담 위저드 UI

#### Step 1: 기본정보 + 배경설문
- 시험 날짜 (DatePicker)
- 난이도 선택 (6-6, 6-5, 5-5 등 16가지)
- 응시 전 등급 (grade_before_exam, 9단계)
- 배경설문: 추천 사용 or 직접 입력
  - 직접 입력 시: 직업/학생/수업/거주지 (라디오 4개) + 여가/취미/운동/여행 (체크박스 4개, 최소 12개)

#### Step 2: 14개 질문 입력 (핵심 UI)
- **5단계 진행** (일반콤보1 → 일반콤보2 → 일반콤보3 → 롤플레이 → 어드밴스)
- **TopicPagination**: 주제 그리드 (PC 3×3, 모바일 2×4) + 페이지네이션
  - 각 주제 카드: 이모지 아이콘 + 주제명 + 질문 수
  - 특수 옵션: "기억 안남" (콤보 전체), "직접 입력"
- **QuestionSelector**: 주제 선택 → master_questions 로드 → 질문 선택
  - 각 질문 카드: 영문 질문 + 한글 번역 + answer_type 뱃지
  - 커스텀 입력 텍스트박스
  - "기억 안남" 체크박스
- **API**: `master-questions/combos` (주제 목록), `master-questions?topic=X&category=Y` (질문 목록)

#### Step 3: 후기 작성
- overall_review (Textarea, 자유 서술)
- tips (Textarea, 선택)
- 완료 → 100포인트 지급 → complete 페이지 리다이렉트

### 소리담 핵심 타입

```typescript
interface SubmissionStep1Request {
  exam_date: string;
  exam_difficulty: string;        // "5-5" 등
  achieved_level?: string;
  grade_before_exam?: string;
  survey_data: {
    used_recommended_survey: boolean;
    survey_occupation?: string;
    survey_student?: string;
    survey_course?: string;
    survey_housing?: string;
    survey_leisure?: string;      // 콤마 구분
    survey_hobbies?: string;
    survey_sports?: string;
    survey_travel?: string;
  };
}

interface SubmissionStep2Item {
  question_number: number;        // 2~15
  combo_type: string;             // '일반콤보1' 등 (한국어)
  topic: string;
  master_question_id?: string;    // SEL_/COM_ 접두사
  custom_question_text?: string;
  is_not_remembered?: boolean;
}

interface SubmissionStep3Request {
  overall_review?: string;
  tips?: string;
}
```

### 소리담 데이터 플로우

```
Step 1 → submissions INSERT (status='draft', step_completed=1)
       → 기존 draft 자동 삭제 (1개만 유지)

Step 2 → submission_questions 14개 INSERT (기존 삭제 후)
       → submissions UPDATE (step_completed=2)
       → ⚠️ 소리담은 여기서 DB 트리거로 콤보 자동 생성

Step 3 → submissions UPDATE (overall_review, tips, status='complete', step_completed=3)
       → ⚠️ 소리담 step3 함수에서도 comboExtractor 호출 (이중 안전장치)
       → 포인트 +100 (user_points_history)
       → /submissions/{id}/complete 리다이렉트
```

---

## Part B: 소리담 → 오픽톡닥 변경 사항

| 항목 | 소리담 | 오픽톡닥 | 이유 |
|------|--------|----------|------|
| **공개 범위** | is_public 필드 (선택) | complete = 전체 공개 (M-4) | 기출+설문+후기 즉각 공유 |
| **배경설문** | 8개 필드 (occupation~travel) | **삭제** | 공유 불필요, 통계 가치 낮음 |
| **난이도 선택** | exam_difficulty 컬럼 | **삭제** | Step 1 불필요 |
| **응시 전 등급** | grade_before_exam 컬럼 | **삭제** | 프로필에 이미 있음 |
| **후기 설문** | 없음 | **9개 설문** (통계 활용) | 시험 목적/공부 방법/준비 기간/응시 횟수/체감 난이도/시간 여유/실제 소요 시간 + 한줄 후기/팁 |
| **후기 텍스트** | overall_review 자유 서술 | **한줄 후기** 100자 필수 + 팁 300자 선택 | 구조화 |
| **콤보 테이블** | 2개 (custom_mode_questions + submission_combos) | 1개 (submission_combos만) | M-1 통합 |
| **콤보 생성** | DB 트리거 (Step 2) + Edge Function (Step 3) | Server Action만 (Step 3) | T-3 트리거 원칙 |
| **빈도 계산** | frequency 컬럼 | GROUP BY COUNT(*) | A-5 통합 |
| **포인트/보상** | +100 포인트 | 크레딧 보상 (P-2: script_credits +2, 월 2건 제한) | T-5 횟수제 |
| **combo_type** | 한국어/영어 혼재 | 영어 통일 (general_1/2/3, roleplay, advance) | 일관성 |
| **백엔드** | Edge Functions 16개 | Server Actions (M-2) | T-8 결정 |

---

## Part C: 오픽톡닥 구현 설계

### 공개 정책 (M-4 결정)

**완료된 후기(status='complete')는 전체 공개.**

공개 내용:
- 기출 문제 14개 (submission_questions)
- 설문 응답 9개 (시험 배경 4 + 체감 후기 3 + 시험 기본 정보 2)
- 자유 후기 (한줄 후기 + 팁/조언)

→ 통계 집계에도 활용 (시험 목적별 등급, 준비 기간별 등급, 소요 시간별 등급 등)

---

## 위저드 구조 (3단계)

### Step 1: 시험 기본 정보 + 설문 (9개)

**시험 기본 정보 (2개)**
| 필드 | 컬럼 | 타입 | 필수 |
|------|------|------|------|
| 시험일 | `exam_date` | DATE | 필수 |
| 받은 등급 | `achieved_level` | TEXT (CHECK) | 선택 ("아직 모름" 허용, 나중에 수정 가능) |

**설문 — 시험 배경 (4개)**
| # | 항목 | 컬럼 | 선택지 | 필수 |
|---|------|------|--------|------|
| 1 | 시험 목적 | `exam_purpose` | employment / promotion / job_change / graduation / self_development | 필수 |
| 2 | 공부 방법 | `study_methods` | self_study / online_lecture / academy / study_group / app (복수선택) | 필수 |
| 3 | 준비 기간 | `prep_duration` | under_1w / 1_2w / 3_4w / 1_2m / 3m_plus | 필수 |
| 4 | 응시 횟수 | `attempt_count` | first / 2nd / 3rd / 4th / 5th_plus | 필수 |

**설문 — 체감 후기 (3개)**
| # | 항목 | 컬럼 | 선택지 | 필수 |
|---|------|------|--------|------|
| 5 | 체감 난이도 | `perceived_difficulty` | easy / normal / hard | 필수 |
| 6 | 시간 여유 | `time_sufficiency` | sufficient / adequate / insufficient | 필수 |
| 7 | 실제 소요 시간 | `actual_duration` | under_20 / 20_25 / 25_30 / 30_35 / 35_40 | 필수 |

### Step 2: 기출 문제 14개 입력 (2~15번)

기존과 동일. submission_questions 14개 INSERT.

### Step 3: 자유 후기 (2개) + 완료

| # | 항목 | 컬럼 | 제한 | 필수 |
|---|------|------|------|------|
| 8 | 한줄 후기 | `one_line_review` | 100자 | **필수** |
| 9 | 팁/조언 | `tips` | 300자 | 선택 |

---

## 테이블 설계 (3개)

### submissions (후기 마스터)

```sql
CREATE TABLE submissions (
  id                    SERIAL PRIMARY KEY,
  user_id               UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- Step 1: 시험 기본 정보
  exam_date             DATE NOT NULL,
  achieved_level        TEXT CHECK (achieved_level IN ('AL','IH','IM3','IM2','IM1','IL','NH')),

  -- Step 1: 설문 — 시험 배경
  exam_purpose          TEXT NOT NULL CHECK (exam_purpose IN ('employment','promotion','job_change','graduation','self_development')),
  study_methods         TEXT[] NOT NULL,
  prep_duration         TEXT NOT NULL CHECK (prep_duration IN ('under_1w','1_2w','3_4w','1_2m','3m_plus')),
  attempt_count         TEXT NOT NULL CHECK (attempt_count IN ('first','2nd','3rd','4th','5th_plus')),

  -- Step 1: 설문 — 체감 후기
  perceived_difficulty  TEXT NOT NULL CHECK (perceived_difficulty IN ('easy','normal','hard')),
  time_sufficiency      TEXT NOT NULL CHECK (time_sufficiency IN ('sufficient','adequate','insufficient')),
  actual_duration       TEXT NOT NULL CHECK (actual_duration IN ('under_20','20_25','25_30','30_35','35_40')),

  -- Step 3: 자유 후기
  one_line_review       VARCHAR(100),
  tips                  VARCHAR(300),

  -- 상태 관리
  status                TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft','complete')),
  step_completed        SMALLINT NOT NULL DEFAULT 1,
  submitted_at          TIMESTAMPTZ,
  created_at            TIMESTAMPTZ DEFAULT NOW(),
  updated_at            TIMESTAMPTZ DEFAULT NOW()
);
```
- RLS: 본인 후기 CRUD + **complete 상태는 전체 읽기** (M-4 공개)
- 인덱스: user_id, status, exam_date
- CHECK 제약 사용 (T-2: 향후 선택지 추가 가능성)

### submission_questions (14개 질문 기록)

```sql
CREATE TABLE submission_questions (
  id                  SERIAL PRIMARY KEY,
  submission_id       INTEGER NOT NULL REFERENCES submissions(id) ON DELETE CASCADE,
  question_number     SMALLINT NOT NULL CHECK (question_number BETWEEN 2 AND 15),
  combo_type          TEXT NOT NULL CHECK (combo_type IN ('general_1','general_2','general_3','roleplay','advance')),
  topic               TEXT NOT NULL,
  master_question_id  TEXT REFERENCES master_questions(question_id),
  custom_question_text TEXT,
  is_not_remembered   BOOLEAN DEFAULT false,
  created_at          TIMESTAMPTZ DEFAULT NOW()
);
```
- FK: submission_id → submissions(id) CASCADE, master_question_id → master_questions(question_id)
- 인덱스: submission_id, master_question_id
- combo_type: 영어 통일 (소리담 한국어/영어 혼재 → 영어만)

### submission_combos (통합 콤보 — custom_mode_questions 대체)

```sql
CREATE TABLE submission_combos (
  id              SERIAL PRIMARY KEY,
  submission_id   INTEGER NOT NULL REFERENCES submissions(id) ON DELETE CASCADE,
  combo_type      TEXT NOT NULL CHECK (combo_type IN ('general_1','general_2','general_3','roleplay','advance')),
  topic           TEXT NOT NULL,
  question_ids    TEXT[] NOT NULL,
  created_at      TIMESTAMPTZ DEFAULT NOW()
);
```
- frequency 컬럼 없음 → GROUP BY COUNT(*)로 계산
- 인덱스: submission_id, combo_type

### 빈도 계산 쿼리 예시

```sql
SELECT topic, combo_type, COUNT(*) as frequency
FROM submission_combos
GROUP BY topic, combo_type
ORDER BY frequency DESC;
```

---

## 통계 활용 쿼리 예시

```sql
-- 시험 목적별 등급 분포
SELECT exam_purpose, achieved_level, COUNT(*) as cnt
FROM submissions WHERE status = 'complete' AND achieved_level IS NOT NULL
GROUP BY exam_purpose, achieved_level;

-- 준비 기간별 IH 이상 비율
SELECT prep_duration,
  COUNT(*) FILTER (WHERE achieved_level IN ('AL','IH')) * 100.0 / COUNT(*) as ih_plus_rate
FROM submissions WHERE status = 'complete' AND achieved_level IS NOT NULL
GROUP BY prep_duration;

-- 실제 소요 시간별 등급
SELECT actual_duration, achieved_level, COUNT(*) as cnt
FROM submissions WHERE status = 'complete' AND achieved_level IS NOT NULL
GROUP BY actual_duration, achieved_level;

-- 공부 방법별 등급 (배열 unnest)
SELECT unnest(study_methods) as method, achieved_level, COUNT(*) as cnt
FROM submissions WHERE status = 'complete' AND achieved_level IS NOT NULL
GROUP BY method, achieved_level;
```

---

## Server Actions 구조

> M-2 결정에 따라 Server Actions로 구현.

### 쓰기 (submissions)

| Action | 용도 |
|--------|------|
| `createDraft` | Step 1: draft 생성 (기존 draft 삭제 → 새 INSERT) |
| `saveQuestions` | Step 2: 14개 질문 저장 (기존 삭제 → 14개 INSERT) |
| `complete` | Step 3: 후기 완료 + 콤보 생성 (combo-extractor 호출) |
| `listMy` | 내 후기 목록 (페이지네이션) |
| `getDetail` | 후기 상세 (master_questions JOIN) |
| `delete` | 후기/드래프트 삭제 |
| `updateGrade` | 등급 업데이트 (achieved_level 수정) |

### 읽기 (analysis — Server Component에서 직접 조회)

| Action/Query | 용도 |
|--------------|------|
| `getFrequency` | 빈도 분석 (미인증: 어드밴스만, 인증: 전체) |
| `getTopicQuestions` | 주제별 출제 질문 목록 |
| `getStats` | 전체 통계 (제출 수, 유니크 질문 수, 설문 집계) |
| `getPublicReviews` | 공개 후기 목록 (페이지네이션, 필터) |

---

## 데이터 플로우

```
[Step 1] 시험 기본 정보 + 설문 9개
  → createDraft Server Action
  → 기존 draft 삭제 → 새 submissions INSERT (status='draft', step_completed=1)
  → 저장: exam_date, achieved_level, exam_purpose, study_methods, prep_duration,
          attempt_count, perceived_difficulty, time_sufficiency, actual_duration

[Step 2] 질문 14개 입력 (2~15번)
  → saveQuestions Server Action
  → 기존 submission_questions 삭제 → 14개 INSERT
  → submissions 업데이트 (step_completed=2)
  ※ DB 트리거 없음 — 콤보는 Step 3에서 생성

[Step 3] 자유 후기 (한줄 후기 + 팁/조언) + 완료
  → complete Server Action
  → submissions 업데이트 (one_line_review, tips, step_completed=3, status='complete', submitted_at=NOW())
  → combo-extractor 실행 → submission_combos에 최대 5개 INSERT
  → 크레딧 보상 (P-2): script_credits +2 (월 2건 제한)
```

---

## 콤보 생성 규칙 (combo-extractor)

```
일반콤보1 (2~4번, 3문항): 모두 master_question_id 있고, 기억함, 제외주제 아님 → general_1
일반콤보2 (5~7번, 3문항): 같은 조건 → general_2
일반콤보3 (8~10번, 3문항): 같은 조건 → general_3
롤플레이 (11~13번, 3문항): 모두 master_question_id 있고, 기억함 → roleplay
어드밴스 (14~15번, 2문항): 모두 master_question_id 있고, 기억함, 제외주제 아님 → advance

제외 주제: ['공원', '카페', '하이킹'] — 코드에서 관리 (A-4 반영)
조건 미충족 콤보는 생성하지 않음
```

---

## 빈도 분석 접근 제어

- 미로그인: 어드밴스 카테고리만 노출
- 로그인: 전체 카테고리 (일반 + 롤플레이 + 어드밴스)

---

*최종 업데이트: 2026-02-22*
