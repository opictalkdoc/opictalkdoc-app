# 쉐도잉 모듈 설계

> 의사결정 근거는 [docs/의사결정.md](../의사결정.md) 참조

## 쉐도잉의 위치

쉐도잉은 **스크립트 모듈의 하위 기능**이다.
- 네비게이션: 스크립트 탭 → "쉐도잉 훈련" 탭
- 스크립트 생성 → 패키지 생성(WAV+JSON) → **쉐도잉에서 소비**
- AI 튜터 Level 2도 쉐도잉이지만, 튜터링 컨텍스트(교정 답변 기반)이므로 별도 흐름

## 쉐도잉 vs 튜터링 Level 2 차이

| 구분 | 쉐도잉 (스크립트 모듈) | 튜터링 Level 2 |
|------|----------------------|---------------|
| 진입 | 내 스크립트 선택 → 쉐도잉 | 모의고사 → 진단 → 교정 답변 생성 후 |
| 소스 | 사용자가 만든 스크립트 | AI가 교정한 template_answer |
| 모드 | 4가지 (Listen/Training/Assessment/Real Test) | 쉐도잉만 (텍스트 없이 따라 말하기) |
| 평가 | GPT 5영역 상세 평가 (pronunciation/fluency/grammar/vocabulary/content) | 유사도 평가 (score ≥ 70 통과) |
| DB | shadowing_sessions + shadowing_evaluations | tutoring_attempts (training_level='level2') |
| 결과 | OPIc 등급 추정 + 스크립트 활용도 | 통과/불통과 → Level 3 진행 |

## 테이블 설계 (2개 — script_packages는 4단계에서 정의됨)

### shadowing_sessions (테스트/평가 세션)

```sql
CREATE TABLE shadowing_sessions (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  package_id      UUID NOT NULL REFERENCES script_packages(id) ON DELETE CASCADE,
  script_id       UUID NOT NULL REFERENCES scripts(id) ON DELETE CASCADE,
  question_text   TEXT,                     -- 영문 질문
  question_korean TEXT,                     -- 한글 질문
  topic           TEXT,
  mode            TEXT NOT NULL CHECK (mode IN ('assessment','realtest')),
  status          TEXT DEFAULT 'active' CHECK (status IN ('active','completed')),
  audio_duration  NUMERIC(8,2),             -- 녹음 길이 (초)
  started_at      TIMESTAMPTZ DEFAULT NOW(),
  completed_at    TIMESTAMPTZ
);
```

- Listen/Training 모드는 DB 불필요 (클라이언트 완결)
- Assessment/Real Test만 세션 생성
- expires_at 제거 (세션 만료 없음)
- 포인트 관련 컬럼 제거 (B-4 횟수제)

### shadowing_evaluations (AI 평가 결과)

```sql
CREATE TABLE shadowing_evaluations (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id          UUID NOT NULL REFERENCES shadowing_sessions(id) ON DELETE CASCADE,
  user_id             UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  transcript          TEXT NOT NULL,         -- Whisper STT 결과
  word_count          INTEGER,

  -- 5영역 점수 (5점 만점)
  pronunciation       NUMERIC(3,1),          -- 발음
  fluency             NUMERIC(3,1),          -- 유창성
  grammar             NUMERIC(3,1),          -- 문법
  vocabulary          NUMERIC(3,1),          -- 어휘
  content_score       NUMERIC(3,1),          -- 내용 (content는 예약어 회피)
  overall_score       NUMERIC(5,1),          -- 총점 (0-100)
  estimated_level     TEXT,                  -- OPIc 등급 추정 (IL~AL)
  script_utilization  NUMERIC(5,1),          -- 스크립트 활용도 (0-100)

  -- AI 피드백
  strengths           TEXT[],                -- 강점
  weaknesses          TEXT[],                -- 약점
  suggestions         TEXT[],                -- 개선 제안
  script_analysis     JSONB,                 -- {key_sentences_used, key_vocabulary_used, missing_elements}

  created_at          TIMESTAMPTZ DEFAULT NOW()
);
```

- 소리담의 usage_method, points_used 제거 (횟수제)
- ai_response 원본 저장 제거 (비용 절감)

## 4가지 모드

### 1. Listen Mode (전체 듣기) — 클라이언트 완결

```
[데이터 로드]
  script_packages에서 WAV URL + JSON URL 조회
  JSON에서 shadowing_sentences 파싱

[재생]
  WAV 전체 재생
  currentTime 기반으로 현재 문장 하이라이트
  0.5x ~ 2.0x 속도 조절
  영문/한글/둘 다 표시 전환
  자동 스크롤
```

- DB 호출 없음, API 호출 없음
- Zustand 로컬 상태 관리

### 2. Training Mode (문장별 훈련) — 클라이언트 완결

```
[문장 선택]
  문장 목록에서 훈련할 문장 선택 (또는 순차 진행)

[훈련 루프]
  1. 해당 문장 구간만 오디오 재생
  2. 사용자 따라 읽기 → 녹음
  3. 클라이언트 발음 비교 (Web Speech API 또는 단순 완료 확인)
  4. 연습 횟수 카운트 (localStorage)
  5. 다음 문장으로 이동

[반복 설정]
  구간 반복 (A-B repeat)
  문장 간 일시정지 시간 조절
```

- DB 호출 없음, 포인트 소비 없음
- 진도 추적은 localStorage (Zustand persist)

### 3. Assessment Mode (사전 평가) — API 호출

```
[녹음]
  전체 스크립트 1회 읽기 → 녹음

[평가] shadowing-evaluate.ts
  1. 구독 횟수 체크 (B-4)
  2. Whisper STT (텍스트 변환)
  3. 발화 길이 검증 (최소 5단어)
  4. ai_prompt_templates에서 'evaluate_shadowing' 프롬프트 로드
  5. GPT-4.1 평가 (5영역 + OPIc 등급 + 스크립트 활용도)
  6. shadowing_sessions (mode='assessment') + shadowing_evaluations 저장

[결과]
  5영역 레이더 차트 + 등급 + 맞춤 훈련 가이드
```

### 4. Real Test Mode (실전 테스트) — API 호출

```
[준비]
  스크립트 텍스트 완전 숨김 (질문만 표시)

[녹음]
  자유 답변 녹음

[평가] 동일 shadowing-evaluate.ts (mode='realtest')
  → Assessment와 동일한 파이프라인
  → Real Test는 script_utilization 가중치 더 높음

[결과]
  5영역 + 등급 + 스크립트 활용도 분석
  이전 평가 대비 변화 표시
```

## ai_prompt_templates에 추가 (1행)

```sql
INSERT INTO ai_prompt_templates (template_id, mode, prompt_name, content, model, max_tokens) VALUES
('evaluate_shadowing', 'evaluate', '쉐도잉 평가', '...RCTF 형식...', 'gpt-4.1', 2000);
```

- 변수: `{{question_text}}`, `{{transcript}}`, `{{training_script}}`, `{{key_expressions}}`
- 출력: JSON (pronunciation, fluency, grammar, vocabulary, content, overall_score, estimated_level, script_utilization, strengths, weaknesses, suggestions, script_analysis)

## Edge Function 구조 (scripts/ 에 통합)

```
supabase/functions/scripts/
├── handlers/
│   ├── ... (기존 4단계 핸들러)
│   ├── shadowing-session-create.ts   ← 세션 생성 (assessment/realtest)
│   ├── shadowing-evaluate.ts         ← Whisper STT + GPT 평가
│   └── shadowing-history.ts          ← 평가 히스토리 조회
├── utils/
│   ├── ... (기존 유틸)
│   └── sentence-matcher.ts           ← Levenshtein 매칭 + 갭 보정
```

## 타임스탬프 매칭 알고리즘 (패키지 생성 시)

패키지 생성 Step 2 (`generate-shadowing.ts`)에서 실행:

```
[입력]
  - WAV 파일 (Storage에서 다운로드)
  - sentence_data (scripts 테이블에서 조회)

[Step 1] Whisper word-level STT
  → response_format='verbose_json', timestamp_granularities=['word']
  → {text, words: [{word, start, end}, ...]}

[Step 2] 문장-단어 매칭 (sentence-matcher.ts)
  → 각 GPT 문장을 Whisper 단어 배열에서 슬라이딩 윈도우로 검색
  → 텍스트 정규화: 소문자 + 구두점 제거 + 아포스트로피 제거
  → Levenshtein Distance 유사도 계산
  → 가장 높은 유사도 위치의 타임스탬프 추출

[Step 3] 갭 보정 (fillTimestampGaps)
  → 문장 간 갭 > 0.5초 → 중간값으로 조정
  → 오버랩 → 경계를 중간값으로 조정

[Step 4] JSON 생성 + Storage 업로드
  → {script_id, shadowing_sentences: [{index, english, korean, start, end, duration}], metadata}
  → script_packages 업데이트 (json_url, status='completed')
```

## 쉐도잉 JSON 파일 구조

```json
{
  "script_id": "uuid",
  "shadowing_sentences": [
    {
      "index": 0,
      "english": "I usually go to the park on weekends.",
      "korean": "나는 보통 주말에 공원에 가요.",
      "start": 0.10,
      "end": 1.85,
      "duration": 1750
    }
  ],
  "metadata": {
    "word_level_matching": true,
    "sentence_count": 5,
    "generated_at": "2026-02-20T..."
  }
}
```

## 클라이언트 상태 관리 (Zustand)

```typescript
// useShadowingStore
interface ShadowingState {
  // 데이터
  packageId: string | null;
  sentences: ShadowingSentence[];
  audioUrl: string | null;

  // 재생
  currentIndex: number;
  isPlaying: boolean;
  playbackRate: number;           // 0.5 ~ 2.0
  displayMode: 'both' | 'english' | 'korean';
  currentTime: number;

  // 반복
  repeatMode: 'none' | 'current' | 'all' | 'ab';
  pauseBetweenSentences: number;  // 초
  abRepeatStart: number | null;
  abRepeatEnd: number | null;

  // 진도 (localStorage persist)
  completedSentences: Set<number>;
  practiceCount: Map<number, number>;
}
```

## 소리담 대비 변경 요약

| 항목 | 소리담 | 오픽톡닥 |
|------|--------|----------|
| 테이블명 | shadowing_test_sessions / evaluations | shadowing_sessions / evaluations |
| 세션 만료 | 24시간 (expires_at) | 만료 없음 |
| 모드 | 4가지 (Listen/Training/Assessment/Real Test) | 동일 4가지 |
| 평가 구조 | 5영역 + OPIc 등급 + 스크립트 활용도 | 동일 |
| 포인트 | 10P/회 + 환불 로직 | 구독 횟수 체크 (B-4) |
| 프롬프트 | admin_prompts (feature_type='shadowing_test') | ai_prompt_templates (template_id='evaluate_shadowing') |
| Edge Function | 3개 별도 함수 | scripts/ 하위 핸들러 3개 통합 |
| 패키지 | ai_training_packages (PDF+WAV+JSON) | script_packages (WAV+JSON, PDF 제거) |
| 프론트엔드 | shadowingService SOLID 패턴 | 동일 패턴 유지 |
| 타임스탬프 매칭 | Levenshtein + 갭 보정 | 동일 알고리즘 이관 |

---

*최종 업데이트: 2026-02-22*
