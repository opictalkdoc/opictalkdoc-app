# 스크립트 모듈 설계

> 의사결정 근거는 [의사결정.md](../의사결정.md) 참조

## 테이블 설계 (3개)

### scripts (통합 스크립트 — 스크립트 생성 + 튜터링 교정 공유)

```sql
CREATE TABLE scripts (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  question_id     TEXT NOT NULL REFERENCES master_questions(question_id),
  source          TEXT NOT NULL DEFAULT 'generate' CHECK (source IN ('generate','correct')),
  title           TEXT,
  english_text    TEXT NOT NULL,
  korean_translation TEXT,
  sentence_data   JSONB,             -- [{index, english, korean, paragraph}]
  total_slots     SMALLINT,          -- 슬롯 개수 (교정 시 슬롯 구조 활용)
  slots           JSONB,             -- [{slot_function, english, korean, keywords}] 튜터링 훈련용
  category        TEXT,              -- topic_category 값
  topic           TEXT,
  question_korean TEXT,
  question_english TEXT,
  user_story      TEXT,              -- 생성 시 한국어 스토리
  user_original_answer TEXT,         -- 교정 시 학습자 원본 답변
  target_level    TEXT,
  answer_type     TEXT,
  ai_model        TEXT DEFAULT 'gpt-4.1',
  word_count      INTEGER,
  generation_time INTEGER,           -- 초 단위
  key_expressions JSONB DEFAULT '[]',
  highlighted_script TEXT,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  updated_at      TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, question_id)      -- 사용자당 질문당 1개 (UPSERT)
);
```

- 인덱스: user_id, question_id, category, source
- UNIQUE(user_id, question_id): 재생성/재교정 시 기존 덮어쓰기
- **스크립트 모듈과 튜터링 모듈이 동일 테이블 공유**:
  - 스크립트에서 생성한 결과 → 튜터링에서 재활용 (재교정 불필요)
  - 튜터링에서 교정한 결과 → 스크립트에서 재활용 (재생성 불필요)
  - 사용자가 명시적으로 "다시 만들기" 할 때만 새로 생성
- source='generate': 스크립트 모듈에서 생성 (user_story 입력)
- source='correct': 튜터링에서 교정 (user_original_answer 입력)
- prompt_id/prompt_name 제거 (단일 프롬프트이므로 불필요)

### script_packages (TTS 음성 + 쉐도잉 타임스탬프)

```sql
CREATE TABLE script_packages (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID NOT NULL REFERENCES auth.users(id),
  script_id       UUID NOT NULL REFERENCES scripts(id) ON DELETE CASCADE,
  status          TEXT DEFAULT 'processing' CHECK (status IN ('processing','completed','partial','failed')),
  progress        SMALLINT DEFAULT 0,
  wav_file_path   TEXT,              -- Storage 공개 URL (TTS 음성)
  json_file_path  TEXT,              -- Storage 공개 URL (쉐도잉 타임스탬프)
  timestamp_data  JSONB,             -- [{text, start, end}]
  wav_file_size   INTEGER,
  error_message   TEXT,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  completed_at    TIMESTAMPTZ
);
```

- PDF 생성 제거 — 패키지 = WAV 음성 + 쉐도잉 JSON (2개 파일)
- 스크립트 재생성 시 기존 패키지 + Storage 파일 자동 삭제

### ai_prompt_templates (RCTF 형식 프롬프트 — 스크립트 + 튜터링 공유)

```sql
CREATE TABLE ai_prompt_templates (
  id              SERIAL PRIMARY KEY,
  template_id     TEXT UNIQUE NOT NULL,     -- 'script_rctf', 'evaluate_level', 'evaluate_realtest'
  prompt_name     TEXT,                     -- 사람이 읽을 수 있는 이름
  content         TEXT NOT NULL,            -- RCTF 형식 전체 (═══ 구분자로 섹션 분리)
  model           TEXT DEFAULT 'gpt-4.1',
  temperature     NUMERIC(2,1) DEFAULT 0.7,
  max_tokens      INTEGER DEFAULT 4000,
  response_format TEXT DEFAULT 'json',
  is_active       BOOLEAN DEFAULT true,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  updated_at      TIMESTAMPTZ DEFAULT NOW()
);
```

- **RCTF 형식**: `═══` 구분자로 [R]Role → [C]Context → [T]Task → [F]Format 4섹션 구분
- content 안에 `${script_spec}` 플레이스홀더 → script_specs 테이블의 content가 삽입됨
- **script_rctf**: 스크립트 생성 + 튜터링 답변 교정에 **동일 프롬프트 1개** 사용
  - 생성: 입력 = 한국어 스토리 → 출력 = 목표 등급 슬롯 구조 영어 스크립트
  - 교정: 입력 = 학습자 답변 → 출력 = 목표 등급 슬롯 구조로 교정된 답변
  - 소리담에선 3가지 방식(AI generator, template IL-IM2, template IM3-AL) → 오픽톡닥은 1가지로 통일
  - 소리담 튜터링의 'correct' 프롬프트(최신 RCTF)를 그대로 사용
- evaluate_level: Level 2/3 슬롯 기반 평가 | evaluate_realtest: Level 4 체크박스 Before/After 비교
- **소리담 최신 시스템(script_prompt_templates 'correct') 기반**
- 데이터: 4행 (script_rctf, evaluate_level, evaluate_realtest, evaluate_shadowing)

### script_specs (등급별 스크립트 규격서 — 60행)

```sql
CREATE TABLE script_specs (
  id              SERIAL PRIMARY KEY,
  guide_id        TEXT UNIQUE NOT NULL,     -- 'description_IL', 'routine_IM2', 'advanced_14_AL' 등
  answer_type     TEXT NOT NULL,            -- 10가지 답변 유형
  target_level    TEXT NOT NULL,            -- IL, IM1, IM2, IM3, IH, AL
  total_slots     SMALLINT NOT NULL,        -- 등급별 슬롯 개수 (IL=3, IM1=4, IM2=5, IM3=6, IH=7, AL=8+)
  content         TEXT NOT NULL,            -- Markdown 형식 규격서 (분량 기준, 담화 패턴, 언어 기준, 슬롯 구조, 예시)
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  updated_at      TIMESTAMPTZ DEFAULT NOW()
);
```

- 10 answer_type × 6 level = **60행** 시드 데이터 (소리담에서 이관)
- 스크립트 생성과 튜터링 교정 모두 같은 규격서 참조
- 프롬프트 조합: `ai_prompt_templates.content` 내 `${script_spec}` → `script_specs.content`로 치환
- 변수 치환: `{{answer_type}}`, `{{level}}`, `{{question}}`, `{{user_story}}` 등

## Edge Function 구조 (1개)

```
supabase/functions/scripts/
├── index.ts                        ← 라우팅
├── handlers/
│   ├── generate.ts                 ← 스크립트 AI 생성 (GPT-4.1)
│   ├── refine.ts                   ← 스크립트 수정/정제
│   ├── get.ts                      ← 스크립트 단건 조회
│   ├── list.ts                     ← 내 스크립트 목록 + 통계
│   ├── delete.ts                   ← 스크립트 삭제 (+ 패키지 연쇄)
│   ├── questions-with-scripts.ts   ← 질문 목록 + 보유 현황
│   ├── generate-package.ts         ← 패키지 Step 1 (Gemini TTS → WAV)
│   ├── generate-shadowing.ts       ← 패키지 Step 2 (Whisper → 타임스탬프)
│   └── package-status.ts           ← 패키지 상태 조회
├── utils/
│   ├── prompt-loader.ts            ← ai_prompt_templates + script_specs 로드/조합
│   ├── script-cleanup.ts           ← 재생성 시 기존 패키지/파일 삭제
│   └── permission-check.ts         ← 구독 횟수 체크 (포인트 아님)
```

## 스크립트 생성 플로우

```
[사용자 입력] question_id + target_level + user_story (선택)

[generate.ts]
  1. 구독 횟수 체크 (B-4: 횟수제)
  2. master_questions에서 질문 데이터 로드
  3. ai_prompt_templates에서 'script_rctf' 프롬프트 로드 (생성/교정 동일)
  4. script_specs에서 guide_id(answer_type_level) 규격서 로드
  5. RCTF 프롬프트 조합: ${script_spec} → 규격서, {{변수}} → 실제 값 치환
  6. GPT-4.1 호출 → JSON (english, korean, sentences[])
  6. scripts UPSERT (user_id + question_id)
  7. 기존 패키지 삭제 (script-cleanup)
  → 스크립트 반환
```

## 패키지 생성 플로우 (PDF 제거)

```
[Step 1] generate-package (TTS만)
  1. scripts에서 english_text, sentence_data 조회
  2. Gemini TTS → WAV (voice: Zephyr, 24kHz 모노)
  3. Storage 업로드 (script-packages 버킷)
  4. script_packages INSERT (status: processing, progress: 60%)
  → package_id 반환

[Step 2] generate-shadowing (Whisper + 타임스탬프)
  1. WAV 다운로드
  2. Whisper STT (word-level timestamps)
  3. sentence_data와 Whisper 단어 매칭 → timestamp_data
  4. JSON Storage 업로드
  5. script_packages UPDATE (status: completed, progress: 100%)
  ※ Step 2 실패 시 status='partial' (WAV는 유효)
```

## 소리담 대비 변경 요약

| 항목 | 소리담 | 오픽톡닥 |
|------|--------|----------|
| 테이블명 | ai_training_scripts/packages | scripts / script_packages |
| 프롬프트 | 3가지 방식 혼재 (AI generator, template IL-IM2, IM3-AL) | 1가지 통일 (script_rctf). 소리담 'correct' RCTF 기반. 생성/교정 동일 프롬프트 |
| 패키지 구성 | WAV + PDF + JSON (3파일) | WAV + JSON (2파일, PDF 제거) |
| 권한 체크 | AIPermissionService 포인트 50P | 구독 횟수 체크 (B-4) |
| 캐시 | ai_training_cache (24시간 해시) | 제거 (UPSERT로 충분) |
| 모니터링 | usage_logs + metrics | 제거 (추후 필요 시 추가) |
| Edge Function | 13개 | 1개 scripts/ |
| Storage 버킷 | ai-training-packages | script-packages |

---

*최종 업데이트: 2026-02-22*
