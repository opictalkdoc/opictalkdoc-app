# AI 튜터링 모듈 설계

> **의사결정 근거**: [docs/의사결정.md](../의사결정.md) 참조
> - T-6: Edge Function 구조 — 모듈별 1개 함수 + handlers/ 분리
> - T-5: 포인트 시스템 → 횟수제 전환 (B-4)
> - T-8: 백엔드 아키텍처 — Server Components + Server Actions

---

## 소리담 대비 핵심 개선사항

1. **Level 1 변경**: 드래그 앤 드롭 → 듣고 따라 읽기 (Read Aloud)
2. **Level 2 신규**: 쉐도잉 (텍스트 없이 따라 말하기) 추가
3. **Level 3 통합**: 기존 Level 2+3 → 힌트 보고 말하기
4. **세션 만료 제거**: 24시간 → 만료 없음, 언제든 이어하기
5. **반복 학습 추가**: 1일→3일→7일 복습 스케줄
6. **성장 추적 추가**: answer_type별 시간 추이 그래프

---

## 테이블 설계 (6개 — scripts + ai_prompt_templates + script_specs는 4단계와 공유)

### tutoring_sessions (세션)

```sql
CREATE TABLE tutoring_sessions (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id             UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  mock_test_session_id TEXT NOT NULL,
  target_level        TEXT,
  status              TEXT DEFAULT 'active' CHECK (status IN ('active','paused','completed')),
  total_types         SMALLINT,
  completed_types     SMALLINT DEFAULT 0,
  current_type_index  SMALLINT DEFAULT 0,
  started_at          TIMESTAMPTZ DEFAULT NOW(),
  last_activity_at    TIMESTAMPTZ,
  created_at          TIMESTAMPTZ DEFAULT NOW()
);
```

- expires_at 제거 — 만료 없음, 언제든 이어하기 가능
- 'expired' 상태 제거, 'paused' 유지 (앱 닫으면 자동 일시정지)

### tutoring_progress (유형별 진행)

```sql
CREATE TABLE tutoring_progress (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id          UUID NOT NULL REFERENCES tutoring_sessions(id) ON DELETE CASCADE,
  answer_type         TEXT NOT NULL,
  type_index          SMALLINT NOT NULL,
  status              TEXT DEFAULT 'pending' CHECK (status IN ('pending','in_progress','completed')),
  current_level       TEXT DEFAULT 'level1' CHECK (current_level IN ('level1','level2','level3','level4')),
  pass_count          SMALLINT DEFAULT 0,
  fail_count          SMALLINT DEFAULT 0,
  script_id           UUID,               -- scripts 테이블 참조 (생성/교정 결과 공유)
  current_question_id TEXT,
  before_checkboxes   JSONB,
  after_checkboxes    JSONB,
  started_at          TIMESTAMPTZ,
  completed_at        TIMESTAMPTZ
);
```

- level 이름 변경: level1(읽기) / level2(쉐도잉) / level3(힌트 말하기) / level4(실전)

### tutoring_template_answers → 제거 (scripts 테이블로 통합)

- 기존 tutoring_template_answers의 역할을 scripts 테이블이 대체
- 튜터링 교정 결과 → scripts에 source='correct'로 저장
- 스크립트 생성 결과 → scripts에 source='generate'로 저장
- **양방향 재활용**: 같은 user_id + question_id면 기존 scripts 재사용
  - 스크립트 모듈에서 이미 생성함 → 튜터링에서 교정 불필요
  - 튜터링에서 이미 교정함 → 스크립트에서 생성 불필요
  - 사용자가 "다시 만들기" → UPSERT로 덮어쓰기
- scripts.slots: 슬롯 구조 (Level 3 힌트 보고 말하기에서 활용)
- scripts.english_text: Level 1(읽기) + Level 2(쉐도잉) TTS 소스로 사용

### tutoring_attempts (훈련 시도)

```sql
CREATE TABLE tutoring_attempts (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id             UUID NOT NULL REFERENCES auth.users(id),
  progress_id         UUID NOT NULL REFERENCES tutoring_progress(id) ON DELETE CASCADE,
  script_id           UUID NOT NULL REFERENCES scripts(id),
  attempt_number      SMALLINT,
  training_level      TEXT NOT NULL CHECK (training_level IN ('level1','level2','level3','level4')),
  user_answer         TEXT,
  user_audio_url      TEXT,
  score               NUMERIC(5,2),
  passed              BOOLEAN,
  total_slots         SMALLINT,
  slot_evaluations    JSONB,
  overall_score       NUMERIC(5,2),
  structure_score     NUMERIC(5,2),
  checkbox_evaluation JSONB,
  final_score         NUMERIC(5,2),
  retry_slots         JSONB,
  strengths           TEXT[],
  improvements        TEXT[],
  feedback            TEXT,
  created_at          TIMESTAMPTZ DEFAULT NOW()
);
```

### tutoring_slot_templates (슬롯 뼈대 — 시드 데이터)

```sql
CREATE TABLE tutoring_slot_templates (
  id              SERIAL PRIMARY KEY,
  template_id     TEXT UNIQUE NOT NULL,
  answer_type     TEXT NOT NULL,
  template_level  TEXT NOT NULL,
  answer_type_ko  TEXT,
  total_slots     SMALLINT,
  prompt_fragment TEXT,
  is_active       BOOLEAN DEFAULT true
);
```

### ai_prompt_templates + script_specs (스크립트와 공유 — 4단계에서 정의)

- 별도 테이블 없음. 4단계 ai_prompt_templates + script_specs 공유
- template_id='script_rctf': 답변 교정에 사용 (스크립트 생성과 동일한 프롬프트, 입력만 다름)
- template_id='evaluate_level': Level 2/3 슬롯별 평가
- template_id='evaluate_realtest': Level 4 체크박스 Before/After 비교 평가

### tutoring_review_schedule (반복 학습 스케줄 — 신규)

```sql
CREATE TABLE tutoring_review_schedule (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  progress_id     UUID NOT NULL REFERENCES tutoring_progress(id) ON DELETE CASCADE,
  answer_type     TEXT NOT NULL,
  next_review_at  TIMESTAMPTZ NOT NULL,
  review_count    SMALLINT DEFAULT 0,
  interval_days   SMALLINT DEFAULT 1,
  status          TEXT DEFAULT 'scheduled' CHECK (status IN ('scheduled','completed','skipped')),
  created_at      TIMESTAMPTZ DEFAULT NOW()
);
```

- Real Test 통과 시 자동 생성: 1일 → 3일 → 7일 간격
- 복습은 Level 3(힌트 보고 말하기)부터 시작
- 대시보드에서 "오늘 복습할 유형" 알림 표시

### tutoring_skill_history (성장 추적 — 신규)

```sql
CREATE TABLE tutoring_skill_history (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  answer_type     TEXT NOT NULL,
  mock_test_session_id TEXT,
  pass_rate       NUMERIC(5,4),
  tested_at       TIMESTAMPTZ DEFAULT NOW()
);
```

- 모의고사 볼 때마다 자동 기록
- "comparison: 30% → 55% → 70%" 시간 추이 그래프 표시

---

## Edge Function 구조 (1개)

```
supabase/functions/tutoring/
├── index.ts                            ← 라우팅
├── handlers/
│   ├── start.ts                        ← 세션 시작 (약점 분석 → progress 생성)
│   ├── get-diagnosis.ts                ← 진단 결과 조회
│   ├── get-progress.ts                 ← 진행 상태 조회
│   ├── get-original-answer.ts          ← 모의고사 원본 답변 조회
│   ├── generate-corrected-script.ts    ← AI 교정 → scripts UPSERT (없을 때만, 있으면 재활용)
│   ├── evaluate-attempt.ts             ← 훈련 시도 평가 (Level 1~4)
│   ├── next-question.ts                ← 다음 유형 활성화
│   ├── transcribe.ts                   ← Whisper STT
│   ├── generate-tts.ts                 ← 문장별 TTS (Level 1, 2용)
│   ├── get-review-schedule.ts          ← 복습 스케줄 조회 (신규)
│   └── get-skill-history.ts            ← 성장 추적 조회 (신규)
├── utils/
│   ├── weakness-analyzer.ts            ← 약점 진단 (pass_rate 집계)
│   ├── prompt-loader.ts                ← ai_prompt_templates + script_specs 로드/조합
│   ├── slot-evaluator.ts              ← 슬롯별 평가 로직
│   └── review-scheduler.ts            ← 복습 스케줄 생성 (1→3→7일)
```

---

## 4단계 훈련 플로우 (개선안)

```
[세션 시작] start.ts
  → mock_test_evaluations에서 answer_type별 pass_rate 집계
  → 점수 낮은 순 정렬 → tutoring_sessions + progress 생성
  → tutoring_skill_history에 현재 pass_rate 기록

[진단] get-diagnosis
  → 우선순위 유형 + 약점 체크박스 + 성장 추이 표시

[훈련 준비]
  → get-original-answer: 최저 pass_rate 문항 선택
  → scripts 테이블 조회: 해당 user_id + question_id에 이미 스크립트 있는지 확인
  → 있으면 재활용 (스크립트 모듈에서 이미 생성한 것 포함)
  → 없으면 generate-corrected-script: GPT-4.1 RCTF → scripts에 source='correct'로 UPSERT

[Level 1] 듣고 따라 읽기 (Read Aloud)
  → 교정 답변 텍스트 표시 + TTS 문장별 재생
  → 사용자가 문장별로 따라 읽기 → 녹음 → 발음 평가
  → 완료 시 → Level 2

[Level 2] 쉐도잉 (Shadowing)
  → 텍스트 숨김, TTS 문장별 재생만
  → 들은 직후 따라 말하기 → STT → 유사도 평가
  → score ≥ 70 통과 → Level 3 | 실패 → Level 2 재시도

[Level 3] 힌트 보고 말하기 (Guided Speaking)
  → slot_function + keywords만 표시 (음성/텍스트 없음)
  → 기억 더듬어 말하기 → STT → GPT-4.1 평가
  → 통과 → Level 4 | 실패 → Level 2 복귀

[Level 4] 실전 테스트 (Real Test)
  → 질문만 표시, 모든 힌트 제거
  → 녹음 → STT → GPT-4.1 체크박스 Before/After 비교
  → 통과: progress completed + 복습 스케줄 생성
  → 실패: Level 2 복귀

[복습] review-scheduler
  → Real Test 통과 1일 후: Level 3부터 재시작
  → 3일 후: Level 3부터
  → 7일 후: Level 4만
  → 복습 완료 시 interval_days * 2로 다음 복습 생성 (최대 30일)
```

---

## 소리담 대비 변경 요약

| 항목 | 소리담 | 오픽톡닥 |
|------|--------|----------|
| 교정 답변 저장 | tutoring_template_answers (튜터링 전용) | scripts 테이블 공유 (source='correct') |
| 스크립트 연동 | 없음 (별도) | 양방향 재활용 — 이미 있으면 재사용, 없을 때만 생성 |
| Level 1 | 드래그 앤 드롭 (읽기 게임) | 듣고 따라 읽기 (발음 연습) |
| Level 2 | 키워드 보고 말하기 | 쉐도잉 (텍스트 없이 따라 말하기) |
| Level 3 | 기능만 보고 말하기 | 힌트 보고 말하기 (L2+L3 통합) |
| Level 4 | Real Test | Real Test (동일) |
| 세션 만료 | 24시간 | 만료 없음 |
| 반복 학습 | 없음 | 1일→3일→7일→14일 복습 스케줄 |
| 성장 추적 | 없음 | answer_type별 pass_rate 시간 추이 |
| 버전 | V1/V2/V3 병존 | 단일 버전 (핵심만) |
| 테이블 | 12+ (V2/V3 포함) | 8개 |
| Edge Function | 10개 + 유틸 20개+ | 1개 tutoring/ |
| 포인트 | AIPermissionService 50P | 구독 횟수 체크 (B-4) |

---

*최종 업데이트: 2026-02-22*
