# 공통 기반 설계

> 모든 모듈에 적용되는 DB/아키텍처 원칙
> 의사결정 근거: `docs/의사결정.md` T-1~T-8

---

## DB 설계 원칙

### FK 전략 (T-1)
- 단일 값 참조 = FK 필수 + ON DELETE 정책
- 배열(TEXT[]) + 불변 데이터 = 배열 유지, FK 생략
- 삭제 정책: 종속=CASCADE, 보호=RESTRICT

### ENUM/CHECK 전략 (T-2)
- 값이 확정된 것 = PostgreSQL ENUM
- 향후 변할 수 있는 것 = CHECK 제약 조건
- 이미 적용: master_questions의 survey_type, topic_category, answer_type

### 트리거 원칙 (T-3)
- 트리거는 단순 작업만: updated_at 자동 갱신, user_sync
- 비즈니스 로직은 Server Actions 또는 Edge Function으로 이전
- 제외 규칙 등 비즈니스 로직은 코드에서 관리

### 테이블 네이밍 (T-7)
- v 접미사 없이 깨끗하게 시작
- 소리담의 mock_test_evaluations_v7 → mock_test_evaluations

---

## 백엔드 아키텍처 (T-8)

| 기능 | 방식 |
|------|------|
| 데이터 조회 | Server Component에서 Supabase 직접 조회 |
| 데이터 변경 | Server Action (`'use server'`) |
| 외부 콜백/웹훅 | API Routes (기존 유지) |

- Edge Functions 사용하지 않음
- 새 API Routes 만들지 않음 (웹훅 제외)

---

## CORS 정책 (T-4)

허용 도메인:
- `opictalkdoc.com`
- `www.opictalkdoc.com`
- `localhost:3000` (개발)

그 외 차단.

---

## 포인트 → 횟수제 (T-5)

소리담의 포인트 시스템 전면 삭제:
- users.points, user_points_history, AIPermissionService 포인트 로직 제거
- 플랜별 모의고사/스크립트 사용 횟수 제한으로 전환
- user_credits 테이블에서 남은 횟수만 관리

---

## Edge Function 통합 원칙 (T-6)

> **참고**: T-8 결정에 따라 시험후기는 Server Actions로 구현.
> 모의고사/스크립트/튜터링은 AI API 호출 등 장시간 처리가 필요하여 Edge Function 유지 가능성 있음.
> 실제 구현 시 모듈별로 판단.

소리담 44개 → 오픽톡닥 6~8개 통합 원칙:
- 모듈별 1개 함수 + 내부 handlers/ 파일 분리
- index.ts는 라우팅만 (~50줄)
- 공통 코드는 _shared/에서 import

---

*최종 업데이트: 2026-02-22*
