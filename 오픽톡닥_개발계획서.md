# 오픽톡닥 (OPIcTalkDoc) 개발 계획서

> **이 문서 하나만 보면 오픽톡닥 개발 전체를 진행할 수 있다.**
> 각 단계에서 참조할 문서와 섹션을 명시해두었으니, 필요할 때 해당 문서를 펼쳐보면 된다.

---

## 관련 문서

| 문서 | 역할 | 언제 보는가 |
|------|------|------------|
| **이 문서 (오픽톡닥_개발계획서.md)** | 마스터 실행 가이드 | 항상 — 다음에 뭘 할지 여기서 확인 |
| `소리담_기능_분석.md` | 이관 요약 + 분석결과 인덱스 | 분석결과에서 어떤 섹션을 봐야 하는지 빠르게 찾을 때 |
| `소리담_분석_결과.md` | 상세 레퍼런스 (60KB) | 실제 코드 작성 시 — 스키마, API, 타입, 플로우 상세 |
| `오픽톡닥_런칭_마스터플랜.md` | 사업/행정/결제 | 결제 연동, PG사 계약, 사업자 정보 확인 시 |
| `오픽톡닥_아토믹_디자인_시스템.md` | 디자인 시스템 | UI 컴포넌트 구현 시 |
| `오픽톡닥_로고_에셋_가이드.md` | 로고/브랜드 가이드 | 디자인 작업 시 |

---

## 개발 원칙

- **소리담 최종 버전만 이관**: 모든 레거시(v4/v6) 무시, 최종 버전(v7 등)만 가져옴
- **오픽톡닥에서 모두 v1**: 소리담 버전 접미사 제거 (예: `evaluations_v7` → `evaluations`)
- **인증/결제는 새로 구축**: 소리담 코드 복사 X → 업계 표준 방식
- **DB는 새로 설계**: 소리담 스키마를 참고하되 정리해서 새로 만듦
- **UI는 오픽톡닥 브랜드**: Tailwind 4.x + 아토믹 디자인 시스템 적용
- **모듈별 풀스택 이관**: DB → Edge Function(API) → TypeScript 타입 → 프론트엔드 → 테스트

---

## 개발 순서 총괄

```
Phase 1 (인증) ✅ 완료
    ↓
Phase 2 (랜딩/필수 페이지) ✅ 완료
    ↓
Phase 3 (핵심 모듈 이관) ← 현재 단계
    ↓
Phase 4 (결제 연동)
    ↓
Phase 5 (관리자)
```

---

## Phase 1. 인증 시스템 ✅ 완료

> Supabase Auth 기반, 업계 표준 방식으로 새로 구축.

| 항목 | 상태 |
|------|------|
| Supabase Auth 설정 (이메일 + Google OAuth) | ✅ |
| 로그인/회원가입 페이지 | ✅ |
| 비밀번호 찾기/재설정 | ✅ |
| 프로필 설정/수정 | ✅ |
| 미들웨어 세션 관리 | ✅ |
| AuthProvider 컨텍스트 | ✅ |

---

## Phase 2. 랜딩 페이지 & 필수 페이지 ✅ 완료

> 카드사 심사 요건 충족 + 서비스 소개.

| 항목 | 상태 |
|------|------|
| 랜딩 페이지 (Nudge 스타일 + 3T 브랜드) | ✅ |
| 요금제 페이지 (무료/베이직 ₩9,900/프리미엄 ₩19,900) | ✅ |
| 이용약관/개인정보처리방침/환불규정 | ✅ |
| Navbar/Footer 공통 레이아웃 | ✅ |
| 사업자정보 푸터 (카드사 심사 요건) | ✅ |

---

## Phase 3. 핵심 모듈 이관 ← 현재 단계

> 소리담에서 선별한 기능을 오픽톡닥에 이관.
> **이 Phase가 개발의 핵심이며, 모듈별로 순서대로 진행한다.**

### 이관 순서 (확정)

```
Step 0: 핵심 코어 (master_questions + custom_mode_questions)
    ↓
Step 1: 데이터랩
    ↓
Step 2: 스크립트 생성
    ↓
Step 3: 모의고사
    ↓
Step 4: AI 튜터
    ↓
Step 5: 내 스크립트
    ↓
Step 6: 쉐도잉
```

### 각 모듈 이관 절차 (공통)

모든 모듈은 아래 순서로 진행한다:

```
1. DB 설계      → Supabase 마이그레이션 SQL 작성
2. RLS 정책     → Row Level Security 설정
3. Edge Function → Supabase Edge Function (Deno) 작성
4. TypeScript 타입 → 프론트에서 쓸 타입 정의
5. API 레이어   → 프론트엔드 API 호출 함수
6. 상태관리     → Zustand 스토어 (필요 시)
7. UI 컴포넌트  → 페이지 + 컴포넌트 구현
8. 테스트       → 동작 확인
```

---

### Step 0: 핵심 코어 — master_questions + custom_mode_questions

> **모든 모듈의 기반. 이것 없이는 아무것도 동작하지 않는다.**
> 📖 분석결과 §2, §3 참조

#### 왜 먼저 하는가

master_questions는 소리담 전체 시스템의 SSOT(Single Source of Truth)이다.
510개 OPIc 질문이 담겨 있고, 모든 학습 모듈이 이 테이블에서 시작된다.
69개 Edge Function이 직접/간접 참조한다.

#### 할 일

**DB 설계:**

| 테이블 | 용도 | 데이터 |
|--------|------|--------|
| `master_questions` | 510개 OPIc 질문 (시스템 코어) | 소리담에서 시드 데이터 이관 |
| `custom_mode_questions` | 콤보 자동 생성 (모의고사 출제용) | 빈 테이블, 트리거 설정 |

**핵심 설계 포인트:**
- `question_id` 코드 시스템 유지: `{SEL/COM}_{topic}_{N/RP/A}_{C#}_{seq}`
- `answer_type` 10가지 정확히 정의 (시스템 전체 분기 기준)
- DB 트리거 `process_custom_mode_questions()` 생성
- RPC 함수 `find_similar_questions_by_frequency()` 생성
- 510개 질문 시드 데이터 INSERT (소리담 프로덕션에서 추출)

**answer_type 10가지** (반드시 기억):

| answer_type | 한국어 | OPIc 문항 |
|-------------|--------|-----------|
| description | 묘사하기 | 2~10번 |
| routine | 루틴 설명 | 2~10번 |
| comparison | 비교하기 | 2~10번 |
| past_experience_memorable | 과거경험(기억에 남는) | 2~10번 |
| past_experience_recent | 과거경험(최근) | 2~10번 |
| past_experience_childhood | 과거경험(어린시절) | 2~10번 |
| roleplay_11 | 롤플레이 11번 | 11번 |
| roleplay_12 | 롤플레이 12번 | 12번 |
| roleplay_13 | 롤플레이 13번 | 13번 |
| advanced_14 / advanced_15 | 어드밴스 | 14~15번 |

> 📖 스키마 상세, question_id 코드, survey_type 분포 → `소리담_분석_결과.md` §2
> 📖 DB 트리거 로직, combo_category 체계 → `소리담_분석_결과.md` §3

---

### Step 1: 데이터랩

> 시험 후기 제출 + 출제 빈도 분석. custom_mode_questions 자동 생성의 시작점.
> 📖 분석결과 §6 참조

#### 페이지 구성

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 대시보드 | `/data-lab` | 전체 통계 (후기 수, 난이도별, 등급별) |
| 빈도 분석 | `/data-lab/analysis` | 카테고리별 출제 빈도 (일반/롤플레이/어드밴스) |
| 후기 제출 | `/data-lab/submissions/new` | 3단계 마법사 (기본정보→질문입력→후기) |
| 내 후기 목록 | `/data-lab/submissions/my-list` | 내 제출 이력 |
| 후기 상세 | `/data-lab/submissions/[id]` | 후기 상세보기 |

#### DB 테이블

| 테이블 | 주요 컬럼 |
|--------|----------|
| `submissions` | user_id, exam_date, exam_difficulty, survey_data(JSONB), status |
| `submission_questions` | submission_id, question_number(2~15), combo_type, master_question_id |

> Step 2 (질문 입력) 시 submission_questions 14개 INSERT → **DB 트리거 발동** → custom_mode_questions 자동 생성

#### Edge Functions (7개)

| Function | 용도 |
|----------|------|
| `data-lab-stats` | 전체 통계 |
| `analysis-frequency` | 빈도 분석 (연도 필터) |
| `analysis-topic-questions` | 주제별 실제 출제 문제 |
| `submissions-step1` | Step 1 저장 |
| `submissions-step2` | Step 2 저장 → **트리거 발동 지점** |
| `submissions-step3` | Step 3 완료 + 포인트 지급 |
| `submissions-my` | 내 후기 목록 |

> 📖 상세 플로우, 타입 정의, 접근 제어 규칙 → `소리담_분석_결과.md` §6

---

### Step 2: 스크립트 생성

> GPT-4로 OPIc 답변 스크립트 자동 생성 + 패키지(TTS/PDF/JSON) 생성.
> 📖 분석결과 §9 참조

#### 페이지 구성

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 카테고리/주제 선택 | `/script-gen` | 빈도순 정렬, 진행 상태 표시 |
| 스크립트 생성 | `/script-gen/create` | 4단계 (주제입력→AI생성→편집→패키지) |

#### DB 테이블

| 테이블 | 주요 컬럼 |
|--------|----------|
| `ai_training_scripts` | user_id, question_id(FK→master_questions), english_text, korean_translation, sentence_data(JSONB) |
| `ai_training_packages` | script_id, status, wav_file_path, pdf_file_path, timestamp_data(JSONB) |

#### Edge Functions (4개)

| Function | 용도 |
|----------|------|
| `ai-training-generate-script-v6` | GPT-4 스크립트 생성 (answer_type별 프롬프트) |
| `ai-training-refine-script` | 스크립트 수정 |
| `ai-training-generate-package` | 패키지 생성 (TTS+PDF+timestamp+JSON) |
| `ai-training-package-status` | 패키지 상태 확인 |

#### 핵심 참고

- AIPermissionService 권한 체크 (subscription > api_key > points > admin)
- answer_type별 다른 GPT-4 프롬프트 전략
- 패키지 생성은 비동기 (status: processing → completed)

> 📖 생성 플로우, 권한 체크, API 상세 → `소리담_분석_결과.md` §9
> 📖 AIPermissionService → `소리담_분석_결과.md` §12

---

### Step 3: 모의고사

> 15문제 세션 + V7 평가 (62개 체크박스 + TypeScript 규칙엔진) + FACT 점수 리포트.
> 📖 분석결과 §7 참조

#### 페이지 구성

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 모의고사 시작 | `/mock-test` | 모드 선택 (빈출/최신/커스텀) |
| 시험 세션 | `/mock-test/session/[id]` | 15문제 순차 진행 (녹음+제출) |
| 상태 대기 | (세션 내) | 평가 진행 폴링 (2초 간격) |
| 리포트 | `/mock-test/report/[id]` | 최종 레벨, FACT 점수, 진단 |
| 나의 모의고사 | `/my-mock-tests` | 이력 목록 + 성장 추이 |

#### DB 테이블

| 테이블 | 주요 컬럼 |
|--------|----------|
| `mock_test_sessions` | user_id, mode(frequent/recent/custom), questions(JSONB), status |
| `mock_test_answers` | session_id, question_number, audio_url, stt_text |
| `mock_test_evaluations` | session_id, question_number, **answer_type**(10가지), checkbox_type(INT/ADV/AL), checkboxes(JSONB) |
| `mock_test_holistic_evaluations` | session_id, rule_engine_status, report_status, final_level, fact_scores(JSONB) |

#### Edge Functions (10개+)

| Function | 용도 |
|----------|------|
| `mock-test-create-v2` | 세션 생성 (custom_mode_questions 콤보 기반 15문제) |
| `mock-test-submit-v2` | 답변 제출 (오디오 → STT + 발음평가) |
| `mock-test-process-v7` | V7 평가 + 규칙엔진 (Q15 시 자동) |
| `mock-test-status-v7` | 상태 폴링 (rule_engine + report) |
| `mock-test-report-v7` | 리포트 조회 |
| `mock-test-history-v7` | 히스토리 + 성장 추이 |
| `mock-test-active-session` | 활성 세션 확인 (이어하기) |
| `mock-test-combos-list` | 커스텀 모드 콤보 목록 |

#### 핵심 참고

- **문제 출제**: custom_mode_questions의 콤보 + frequency → master_questions에서 조회
- **평가 분기**: answer_type에 따라 체크박스 세트가 달라짐 (INT만 vs INT+ADV vs INT+AL)
- **규칙엔진**: TypeScript로 구현 (LLM 아님), Floor/Ceiling/AL/Gate-Keeper 판정
- **이중 상태**: rule_engine_status + report_status 분리
- **오디오 규칙**: 최소 1초, 최대 4분, 최대 10MB, WAV 권장

> 📖 V7 체크박스 구조, 규칙엔진 로직, FACT 점수 → `소리담_분석_결과.md` §7
> 📖 콤보 기반 출제 로직 → `소리담_분석_결과.md` §3

---

### Step 4: AI 튜터

> 모의고사 결과 기반 진단 → 처방 → 훈련 파이프라인. 8대 스킬 + 40개 원인코드.
> 📖 분석결과 §8 참조

#### 페이지 구성

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 대시보드 | `/ai-tutor` | 모의고사 선택 → 세션 생성 |
| 진단 결과 | `/ai-tutor/[sessionId]/diagnosis` | FACT 레이더, Worst 5, 처방 카드 |
| 훈련 메인 | `/ai-tutor/[sessionId]/training/[progressId]` | 레벨 선택 |
| Level 1~3 | `.../level/[level]` | 드래그앤드롭 → 키워드힌트 → 슬롯함수 |
| Real Test | `.../test` | 질문만 + 말하기 (≥80점 3회) |

#### DB 테이블

| 테이블 | 주요 컬럼 |
|--------|----------|
| `tutoring_sessions` | user_id, mock_test_session_id, target_level, total_types(10), completed_types |
| `tutoring_progress` | session_id, **answer_type**(10가지), current_level, before/after_checkboxes |
| `tutoring_template_answers` | progress_id, question_id(FK), slots(JSONB), full_script |
| `tutoring_training_attempts` | progress_id, training_level, score, passed, slot_evaluations(JSONB) |
| `tutoring_prompts` | prompt_key, prompt_text, model, temperature |
| `ai_tutor_skills` | skill_code(8개), cause_code(40개), scoring_rubric(JSONB) |
| `ai_tutor_characters` | character_id(sori/dam), system_prompt |
| `ai_tutor_training_modules` | module_code(48개), target_skill_code, phase_read/type/speak(JSONB) |

#### Edge Functions (7개)

| Function | 용도 |
|----------|------|
| `tutoring-start` | 세션 생성 (10가지 answer_type별 진단) |
| `tutoring-get-diagnosis` | 진단 결과 + FACT + 예측 등급 |
| `tutoring-get-progress` | 유형별 진행 상태 |
| `tutoring-generate-template-answer` | AI 교정 답변 생성 (GPT-4, answer_type별) |
| `tutoring-evaluate-attempt` | 레벨별 시도 평가 |
| `tutoring-next-question` | 다음 유형 이동 |
| `tutoring-generate-tts` | TTS 생성 |

#### 핵심 참고

- **모의고사 의존**: mock_test_evaluations의 체크박스 결과가 입력
- **10가지 유형별 진행**: answer_type 각각에 대해 Level 1→2→3→Real Test
- **듀얼 튜터**: FL/PR → '소리', 나머지 → '담'
- **시드 데이터 필요**: ai_tutor_skills(8+40), ai_tutor_characters(2), ai_tutor_training_modules(48), tutoring_prompts

> 📖 8대 스킬, Phase 구조, 템플릿 답변 구조 → `소리담_분석_결과.md` §8

---

### Step 5: 내 스크립트

> 생성된 스크립트 3패널 관리 + 오디오 동기화 학습.
> 📖 분석결과 §10 참조

#### 페이지 구성

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 3패널 메인 | `/my-scripts` | Sidebar(목록) + ScriptDisplay(스크립트) + AudioPlayer(재생) |

#### Edge Functions (2개)

| Function | 용도 |
|----------|------|
| `my-scripts-list` | 스크립트 목록 (카테고리/주제/페이지 필터) |
| `my-scripts-stats` | 통계 |

#### 핵심 참고

- 별도 DB 테이블 없음 (ai_training_scripts + ai_training_packages 조인)
- timestamp_data 기반 문장별 가라오케 싱크
- master_questions의 question_korean, question_english 표시

> 📖 타입 정의, 오디오 재생 로직 → `소리담_분석_결과.md` §10

---

### Step 6: 쉐도잉

> 패키지 기반 4모드 쉐도잉 훈련. Whisper STT + GPT-4 평가.
> 📖 분석결과 §11 참조

#### 페이지 구성

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 쉐도잉 메인 | `/shadowing/[packageId]` | 4모드 (Listen/Training/Assessment/Real Test) |

#### DB 테이블

| 테이블 | 주요 컬럼 |
|--------|----------|
| `shadowing_sessions` | user_id, package_id, mode |
| `shadowing_attempts` | session_id, sentence_index, 6개 영역 점수, feedback(JSONB) |

#### Edge Functions (2개)

| Function | 용도 |
|----------|------|
| `shadowing-test-create` | 세션 생성 |
| `shadowing-test-evaluate` | 음성 평가 (Whisper STT → GPT-4 → 6개 영역 점수) |

#### 핵심 참고

- 내 스크립트에서 진입 (패키지 완료된 질문만)
- 6개 평가 영역: pronunciation, fluency, grammar, vocabulary, content, overall
- Zustand 스토어 (shadowingStore) 복잡도 높음

> 📖 4모드 상세, Whisper 고도화, Zustand 스토어 구조 → `소리담_분석_결과.md` §11

---

### 공통 인프라 (모든 모듈에서 사용)

> 📖 분석결과 §12 참조

#### 이관 필요 공통 요소

| 요소 | 용도 | 비고 |
|------|------|------|
| AIPermissionService | AI 기능 권한 체크 | 오픽톡닥 구독 모델로 재설계 |
| analysisApi (공유) | 빈도 분석 API | 데이터랩 + 스크립트 + 내 스크립트에서 공유 |
| azure-tts-generate | Azure TTS | 공통 음성 합성 |
| whisper-proxy | Whisper STT | 공통 음성인식 |
| convert-audio | 오디오 변환 | WAV 변환 등 |
| upload | 파일 업로드 | Supabase Storage |

#### 외부 서비스 API 키 필요

| 서비스 | 용도 | 준비 상태 |
|--------|------|----------|
| OpenAI | GPT-4 (평가/생성), Whisper (STT) | 미준비 |
| Azure | TTS (음성 합성), Speech Service (발음 평가) | 미준비 |
| Google Gemini | TTS (master_questions 음성) | 미준비 |

---

## Phase 4. 결제 연동

> 포트원 V2 기반 결제 시스템. Phase 3 진행과 병행 가능.
> 📖 상세: `오픽톡닥_런칭_마스터플랜.md` §4 (결제 시스템)

#### 페이지 구성

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 결제 | `/payment` | 포트원 V2 결제창 호출 |
| 결제 완료 | `/payment/complete` | 성공/실패 처리 |
| 구독 관리 | `/subscription` | 구독 상태 조회/해지 |

#### DB 테이블

| 테이블 | 용도 |
|--------|------|
| `subscriptions` | 구독 상태 (plan, status, period) |
| `payments` | 결제 이력 (amount, method, portone_id) |

#### 결제 수단

| PG사 | 수단 |
|------|------|
| KG이니시스 | 신용카드 일반/정기 결제 |
| 카카오페이 | 간편결제 |
| 네이버페이 | 간편결제 (결제형) |
| 토스페이 | 간편결제 |

#### 구현 항목

- [ ] 포트원 V2 SDK 연동
- [ ] 결제 페이지 구현
- [ ] 결제 완료/실패 처리 (웹훅)
- [ ] 구독 상태 관리 (DB + RLS)
- [ ] AIPermissionService 연동 (구독 기반 권한)

---

## Phase 5. 관리자 페이지

> Phase 3~4 완성 후 필요한 관리 기능을 결정.

| 후보 기능 | 우선순위 |
|----------|---------|
| master_questions 관리 (CRUD) | 높음 |
| 사용자 관리 | 높음 |
| 구독/결제 관리 | 높음 |
| 시드 데이터 관리 (스킬, 모듈, 프롬프트) | 중간 |
| 통계 대시보드 | 낮음 |

---

## 현재 진행 상태

| Phase | 상태 | 다음 할 일 |
|-------|------|-----------|
| Phase 1 (인증) | ✅ 완료 | - |
| Phase 2 (랜딩/필수) | ✅ 완료 | - |
| **Phase 3 (핵심 모듈)** | **🔄 진행 중** | **Step 0: master_questions DB 설계** |
| Phase 4 (결제) | ⏳ 대기 | PG사 심사 진행 중 (병행 가능) |
| Phase 5 (관리자) | ⏳ 대기 | Phase 3 완료 후 |

### 바로 다음 작업

1. **master_questions 테이블 설계** (Supabase 마이그레이션 SQL)
2. **custom_mode_questions 테이블 + DB 트리거 설계**
3. **510개 시드 데이터 준비** (소리담 프로덕션에서 추출)

---

*최종 업데이트: 2026-02-19*
*상태: Phase 3 진입 — Step 0 (핵심 코어 DB 설계) 시작 대기*
